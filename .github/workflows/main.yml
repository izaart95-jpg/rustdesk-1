name: macOS User and Login Configuration Test

on:
  workflow_dispatch:

jobs:
  macos-config-test:
    runs-on: macos-latest
    timeout-minutes: 25

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV
          
          # Create metadata file
          METADATA_FILE="$SCREENSHOT_DIR/test_metadata.txt"
          echo "macOS Configuration Test" > "$METADATA_FILE"
          echo "======================" >> "$METADATA_FILE"
          echo "Date: $(date)" >> "$METADATA_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$METADATA_FILE"

      - name: Initial Screenshot (Clean Desktop)
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Initial screenshot saved: $screenshot_file"

      - name: Enable Multiple Sessions
        run: |
          echo "=== Enabling Multiple Sessions ==="
          
          echo "Setting MultipleSessionEnabled to true..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled -bool true
          
          echo "Setting MultipleSessionName to 'FullName'..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionName -string "FullName"
          
          echo "‚úÖ Multiple session settings configured"
          
          # Verify settings
          echo "Current MultipleSessionEnabled:"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null || echo "Not set"
          
          echo "Current MultipleSessionName:"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName 2>/dev/null || echo "Not set"

      - name: Create Admin User
        run: |
          echo "=== Creating Admin User ==="
          
          # Create new user
          echo "Creating user 'Hamiya' with full name 'Hamiyas'..."
          sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password "Hamza@157" -admin
          
          # Add to admin group (additional method)
          echo "Adding user to admin group..."
          sudo dseditgroup -o edit -a Hamiya -t user admin
          
          # Verify user creation
          echo "Verifying user creation..."
          id Hamiya || echo "User not found"
          
          # Check admin group membership
          echo "Checking admin group membership..."
          dscl . read /Groups/admin GroupMembership || echo "Could not read admin group"
          
          # Try to list users
          echo "List of users:"
          dscl . list /Users | grep -v '_' || echo "Could not list users"
          
          echo "‚úÖ User creation and admin assignment completed"

      - name: Screenshot After Configuration
        run: |
          echo "=== Screenshot After Configuration ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/02_after_config_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Configuration screenshot saved"

      - name: Install cliclick for UI Automation
        run: |
          echo "=== Installing cliclick ==="
          
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          else
            echo "cliclick already installed"
          fi
          
          echo "‚úÖ cliclick ready"

      - name: Open System Settings
        run: |
          echo "=== Opening System Settings ==="
          
          # Close System Settings if already open
          echo "Closing any existing System Settings..."
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          
          # Open System Settings
          echo "Opening System Settings..."
          open -a "System Settings"
          
          # Wait for System Settings to open
          echo "Waiting for System Settings to launch..."
          for i in {1..15}; do
            if pgrep -f "System Settings" > /dev/null; then
              echo "‚úÖ System Settings process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Wait for UI to load
          echo "Waiting for UI to load..."
          sleep 3
          
          # Take screenshot after opening
          screenshot_file="$SCREENSHOT_DIR/03_system_settings_open_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ System Settings screenshot saved"

      - name: Click at 507,363 and Wait
        run: |
          echo "=== Clicking at coordinates (507, 363) ==="
          
          # First, ensure System Settings is in front
          echo "Bringing System Settings to front..."
          osascript <<'EOF'
          tell application "System Settings"
            activate
            delay 1
          end tell
          EOF
          
          sleep 1
          
          # Take screenshot before click
          screenshot_file="$SCREENSHOT_DIR/04_before_507_363_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before click saved"
          
          # Click at 507,363
          echo "Clicking at coordinates (507, 363)..."
          cliclick c:507,363
          
          # Wait 2 seconds as requested
          echo "Waiting 2 seconds after click..."
          sleep 2
          
          # Take screenshot after click
          screenshot_file="$SCREENSHOT_DIR/05_after_507_363_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Screenshot after click saved"

      - name: Search for Fast User Switching
        run: |
          echo "=== Searching for Fast User Switching ==="
          
          # Bring System Settings to front
          osascript <<'EOF'
          tell application "System Settings"
            activate
            delay 1
          end tell
          EOF
          
          sleep 1
          
          # Type "Fast User Switching" in search
          echo "Typing 'Fast User Switching' in search..."
          
          # First click in search field (common location - top right)
          # Different macOS versions have different search locations
          # Let's try a few common approaches
          
          # Method 1: Use AppleScript to search
          echo "Attempting search via AppleScript..."
          
          osascript <<'EOF' 2>&1 || echo "AppleScript search attempted"
          tell application "System Events"
            tell process "System Settings"
              activate
              delay 1
              
              -- Try to find search field
              try
                -- Press Cmd+F for search (universal shortcut)
                keystroke "f" using {command down}
                delay 1
                
                -- Type the search term
                keystroke "Fast User Switching"
                delay 2
                
                -- Press Enter
                key code 36
                delay 2
                
                log "Search completed via keyboard shortcuts"
              on error errMsg
                log "Keyboard shortcut method failed: " & errMsg
                
                -- Alternative: Try clicking common search locations
                try
                  -- Click in potential search field location (varies by macOS version)
                  click at {900, 80}
                  delay 1
                  keystroke "Fast User Switching"
                  delay 2
                  key code 36
                  delay 2
                  log "Search completed via click and type"
                on error errMsg2
                  log "Click method also failed: " & errMsg2
                end try
              end try
            end tell
          end tell
          EOF
          
          # Wait for search results
          echo "Waiting for search results..."
          sleep 3
          
          # Take screenshot of search results
          screenshot_file="$SCREENSHOT_DIR/06_fast_user_switching_search_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Fast User Switching search screenshot saved"

      - name: Click at 858,11 (Close Button)
        run: |
          echo "=== Clicking at coordinates (858, 11) ==="
          
          # Bring System Settings to front
          osascript <<'EOF'
          tell application "System Settings"
            activate
            delay 1
          end tell
          EOF
          
          sleep 1
          
          # Take screenshot before clicking close
          screenshot_file="$SCREENSHOT_DIR/07_before_858_11_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before close button click saved"
          
          # Click at 858,11 (typically close button location)
          echo "Clicking at coordinates (858, 11)..."
          cliclick c:858,11
          
          # Wait a moment
          sleep 2
          
          # Take screenshot after clicking
          screenshot_file="$SCREENSHOT_DIR/08_after_858_11_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Screenshot after close button click saved"

      - name: Final Screenshot and Cleanup
        run: |
          echo "=== Final Steps ==="
          
          # Take final desktop screenshot
          echo "Taking final desktop screenshot..."
          screenshot_file="$SCREENSHOT_DIR/09_final_desktop_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Close System Settings if still open
          echo "Closing System Settings..."
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          pkill -f "System Settings" 2>/dev/null || true
          
          echo "‚úÖ Cleanup completed"

      - name: Capture Configuration Information
        run: |
          echo "=== Capturing Configuration Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/configuration_info.txt"
          
          echo "macOS Configuration Test Report" > "$INFO_FILE"
          echo "==============================" >> "$INFO_FILE"
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Login Window Configuration:" >> "$INFO_FILE"
          echo "---------------------------" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null >> "$INFO_FILE" || echo "MultipleSessionEnabled: Not set" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName 2>/dev/null >> "$INFO_FILE" || echo "MultipleSessionName: Not set" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "User Information:" >> "$INFO_FILE"
          echo "-----------------" >> "$INFO_FILE"
          echo "Checking user 'Hamiya':" >> "$INFO_FILE"
          id Hamiya 2>/dev/null >> "$INFO_FILE" || echo "User 'Hamiya' not found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Admin Group Membership:" >> "$INFO_FILE"
          dscl . read /Groups/admin GroupMembership 2>/dev/null >> "$INFO_FILE" || echo "Could not read admin group" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Actions Performed:" >> "$INFO_FILE"
          echo "----------------------" >> "$INFO_FILE"
          echo "1. Enabled MultipleSessionEnabled = true" >> "$INFO_FILE"
          echo "2. Set MultipleSessionName = 'FullName'" >> "$INFO_FILE"
          echo "3. Created user 'Hamiya' with full name 'Hamiyas'" >> "$INFO_FILE"
          echo "4. Added user to admin group" >> "$INFO_FILE"
          echo "5. Opened System Settings" >> "$INFO_FILE"
          echo "6. Clicked at coordinates (507, 363)" >> "$INFO_FILE"
          echo "7. Searched for 'Fast User Switching'" >> "$INFO_FILE"
          echo "8. Clicked at coordinates (858, 11) - close button" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Screenshots Captured:" >> "$INFO_FILE"
          echo "--------------------" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -exec basename {} \; | sort >> "$INFO_FILE"
          
          echo "‚úÖ Configuration info saved"

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: macos-config-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 7

      - name: Upload Configuration Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-config-report
          path: |
            ${{ env.SCREENSHOT_DIR }}/configuration_info.txt
            ${{ env.SCREENSHOT_DIR }}/test_metadata.txt
          retention-days: 7

      - name: Final Summary
        run: |
          echo "=== macOS Configuration Test Complete ==="
          echo ""
          echo "üìä Summary:"
          echo "  ‚úÖ macOS Version: $(sw_vers -productVersion)"
          echo "  ‚úÖ Multiple session login enabled"
          echo "  ‚úÖ Admin user 'Hamiya' created"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  ‚úÖ $SCREENSHOT_COUNT screenshots captured"
          echo "  ‚úÖ System Settings interaction tested"
          echo "  ‚úÖ UI automation with clicks at specific coordinates"
          echo ""
          echo "üìÅ Artifacts:"
          echo "  ‚Ä¢ All screenshots uploaded as 'macos-config-screenshots'"
          echo "  ‚Ä¢ Configuration report uploaded as 'macos-config-report'"
          echo ""
          echo "üîß Configuration Applied:"
          echo "  ‚Ä¢ MultipleSessionEnabled: true"
          echo "  ‚Ä¢ MultipleSessionName: 'FullName'"
          echo "  ‚Ä¢ User 'Hamiya' added to admin group"
          echo ""
          echo "üéØ Test sequence completed successfully!"
