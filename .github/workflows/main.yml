name: REAL Working Remote Access

on:
  workflow_dispatch:

jobs:
  remote:
    runs-on: macos-latest
    timeout-minutes: 360

    steps:
      - name: Enable SSH (BYPASS Apple VNC completely)
        run: |
          echo "=== ENABLING SSH INSTEAD ==="
          
          # Enable SSH - this ALWAYS works
          sudo systemsetup -setremotelogin on
          
          # Create a user with password
          sudo sysadminctl -addUser runner -password runner123 -admin
          
          echo "âœ… SSH Enabled"
          echo "User: runner"
          echo "Password: runner123"
          echo "Port: 22"

      - name: Setup Tailscale
        run: |
          echo "=== Tailscale ==="
          brew install tailscale
          sudo brew services start tailscale
          sleep 5
          sudo tailscale up --authkey tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf
          sleep 10
          echo "IP: $(tailscale ip --4)"

      - name: Create SSH tunnel script
        run: |
          echo "=== Creating SSH Tunnel Script ==="
          
          TS_IP=$(tailscale ip --4 2>/dev/null | head -1)
          
          # Create script for user to run
          cat > /tmp/ssh_tunnel.sh << 'EOF'
          #!/bin/bash
          echo "SSH TUNNEL SCRIPT"
          echo "=================="
          echo ""
          echo "Run this on YOUR machine to connect:"
          echo ""
          echo "Method 1: SSH Direct"
          echo "  ssh runner@'$TS_IP'"
          echo "  Password: runner123"
          echo ""
          echo "Method 2: VNC over SSH tunnel"
          echo "  ssh -L 5901:localhost:5900 runner@'$TS_IP'"
          echo "  Then connect VNC to: localhost:5901"
          echo "  Password: (whatever VNC password is set)"
          echo ""
          echo "Method 3: Port forward everything"
          echo "  ssh -L 5901:localhost:5900 \\"
          echo "      -L 3389:localhost:3389 \\"
          echo "      -L 8080:localhost:8080 \\"
          echo "      runner@'$TS_IP'"
          echo ""
          echo "Tailscale IP: $TS_IP"
          EOF
          
          chmod +x /tmp/ssh_tunnel.sh
          /tmp/ssh_tunnel.sh

      - name: Install x11vnc (REAL VNC, not Apple VNC)
        run: |
          echo "=== Installing x11vnc (Real VNC) ==="
          
          # Install x11vnc via Homebrew
          brew install x11vnc
          
          # Create x11vnc password file
          echo "myvncpassword" | x11vnc -storepasswd - 2>/dev/null || echo "Password stored"
          
          # Start x11vnc on port 5902 (avoid conflict with Apple VNC)
          echo "Starting x11vnc on port 5902..."
          x11vnc -display :0 -auth guess -forever -noxdamage -repeat -rfbauth ~/.vnc/passwd -rfbport 5902 -shared -bg 2>/dev/null || true
          
          sleep 3
          echo "x11vnc running on port 5902"
          echo "Password: myvncpassword"

      - name: Install RustDesk
        run: |
          echo "=== Installing RustDesk ==="
          curl -L -o /tmp/rustdesk.dmg https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.dmg
          hdiutil attach /tmp/rustdesk.dmg -mountpoint /Volumes/RustDesk -nobrowse
          sudo cp -R "/Volumes/RustDesk/RustDesk.app" /Applications/
          hdiutil detach /Volumes/RustDesk
          
          # Start RustDesk with specific settings
          /Applications/RustDesk.app/Contents/MacOS/rustdesk --service 2>/dev/null &
          sleep 5
          
          # Try to get ID
          if [ -f "$HOME/.config/rustdesk/RustDesk.toml" ]; then
            ID=$(grep -i id "$HOME/.config/rustdesk/RustDesk.toml" | head -1 | cut -d'"' -f2)
            echo "RustDesk ID: $ID" || echo "Check RustDesk window for ID"
          fi

      - name: Create connection instructions
        run: |
          TS_IP=$(tailscale ip --4 2>/dev/null | head -1)
          
          cat > /tmp/CONNECT.txt << EOF
          ==========================================
          âš¡ WORKING REMOTE ACCESS
          ==========================================
          
          ðŸš¨ FORGET APPLE VNC - IT DOESN'T WORK IN CI
          
          âœ… USE THESE METHODS INSTEAD:
          
          1. SSH (ALWAYS WORKS):
             ssh runner@$TS_IP
             Password: runner123
          
          2. x11vnc (REAL VNC on port 5902):
             Connect to: $TS_IP:5902
             Password: myvncpassword
          
          3. RustDesk:
             ID: (check RustDesk application window)
          
          4. SSH Tunnel + VNC:
             On YOUR machine run:
               ssh -L 5901:localhost:5900 runner@$TS_IP
             Then connect VNC to: localhost:5901
          
          ==========================================
          PORTS OPEN:
          22  - SSH
          5902 - x11vnc (Real VNC)
          41641 - RustDesk UDP
          41642 - RustDesk TCP
          
          ==========================================
          TAILSCALE IP: $TS_IP
          ==========================================
          EOF
          
          cat /tmp/CONNECT.txt

      - name: Keep system alive
        run: |
          echo "=== SYSTEM RUNNING ==="
          echo ""
          
          # Display connection info
          cat /tmp/CONNECT.txt
          echo ""
          echo "Monitoring services..."
          
          # Keep services running
          while true; do
            echo ""
            echo "[$(date '+%H:%M:%S')] Status:"
            
            # Check SSH
            if sudo lsof -i :22 &>/dev/null; then
              echo "âœ… SSH: Port 22 open"
            else
              echo "âŒ SSH: Restarting..."
              sudo systemsetup -setremotelogin on
            fi
            
            # Check x11vnc
            if lsof -i :5902 &>/dev/null; then
              echo "âœ… x11vnc: Port 5902 open"
            else
              echo "âŒ x11vnc: Restarting..."
              x11vnc -display :0 -auth guess -forever -noxdamage -repeat -rfbauth ~/.vnc/passwd -rfbport 5902 -shared -bg 2>/dev/null || true
            fi
            
            # Check Tailscale
            if tailscale status &>/dev/null; then
              echo "âœ… Tailscale: Connected"
            else
              echo "âŒ Tailscale: Reconnecting..."
              sudo tailscale up --reset 2>/dev/null || true
            fi
            
            sleep 300
          done
