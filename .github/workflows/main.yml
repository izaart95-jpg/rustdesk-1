name: macOS Settings Sharing Screenshots

on:
  workflow_dispatch:
    inputs:
      search_term:
        description: 'Term to search in Settings'
        default: 'Sharing'
        required: true
      screenshot_count:
        description: 'Number of screenshots to take'
        type: number
        default: 3
        required: true
      delay_seconds:
        description: 'Delay between screenshots (seconds)'
        type: number
        default: 1
        required: true

jobs:
  settings-sharing-screenshots:
    runs-on: macos-latest
    timeout-minutes: 15
    
    steps:
      - name: Check macOS Version
        run: |
          echo "=== Checking macOS Version ==="
          sw_vers
          echo "Running on: $(sw_vers -productVersion)"
          echo "System: $(sw_vers -productName)"
          
      - name: Setup Environment
        run: |
          echo "=== Setting Up Environment ==="
          
          # Create screenshots directory
          SCREENSHOT_DIR="$(pwd)/settings_screenshots"
          mkdir -p "$SCREENSHOT_DIR"
          
          # Store in environment
          echo "SCREENSHOT_DIR=$SCREENSHOT_DIR" >> $GITHUB_ENV
          echo "SEARCH_TERM=${{ github.event.inputs.search_term }}" >> $GITHUB_ENV
          echo "SCREENSHOT_COUNT=${{ github.event.inputs.screenshot_count }}" >> $GITHUB_ENV
          echo "DELAY_SECONDS=${{ github.event.inputs.delay_seconds }}" >> $GITHUB_ENV
          
          echo "üìÅ Screenshot directory: $SCREENSHOT_DIR"
          echo "üîç Search term: $SEARCH_TERM"
          echo "üì∏ Screenshot count: $SCREENSHOT_COUNT"
          echo "‚è±Ô∏è Delay between shots: $DELAY_SECONDS seconds"
          
      - name: Get Screen Resolution
        run: |
          echo "=== Getting Screen Resolution ==="
          
          # Get exact display resolution
          if [ -z "$DISPLAY" ]; then
            export DISPLAY=":99"
          fi
          
          # Multiple methods to get resolution
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | tr -d ',' | awk '{print $3 "x" $4}')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            # Alternative method
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          
          # Fallback to default
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            RESOLUTION="1920x1080"
            echo "‚ö†Ô∏è Using default resolution: $RESOLUTION"
          fi
          
          # Clean and validate
          RESOLUTION=$(echo "$RESOLUTION" | tr -d ',' | tr -d ' ' | sed 's/[^0-9x]//g')
          
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          if ! [[ "$WIDTH" =~ ^[0-9]+$ ]] || ! [[ "$HEIGHT" =~ ^[0-9]+$ ]]; then
            WIDTH="1920"
            HEIGHT="1080"
            RESOLUTION="${WIDTH}x${HEIGHT}"
          fi
          
          echo "‚úÖ Detected resolution: ${WIDTH}x${HEIGHT}"
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          
      - name: Open System Settings
        run: |
          echo "=== Opening System Settings ==="
          
          # Kill System Settings if already running
          pkill -f "System Settings" 2>/dev/null || true
          sleep 2
          
          echo "Opening System Settings app..."
          
          # Open System Settings using different methods
          open -a "System Settings" 2>/dev/null || \
          open -a "System Preferences" 2>/dev/null || \
          open "x-apple.systempreferences:" 2>/dev/null || \
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null
          
          echo "Waiting for System Settings to launch..."
          
          # Wait for app to open
          for i in {1..30}; do
            if pgrep -f "System Settings" > /dev/null || pgrep -f "System Preferences" > /dev/null; then
              echo "‚úÖ System Settings opened (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Additional wait for UI to load
          sleep 5
          
          # Bring to front
          osascript <<'EOF' 2>/dev/null || true
          tell application "System Settings"
            activate
            delay 1
          end tell
          EOF
          
          echo "‚úÖ System Settings should be visible"
          
      - name: Search for Sharing
        run: |
          echo "=== Searching for '$SEARCH_TERM' ==="
          
          # Install cliclick if needed
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick for precise clicking..."
            brew install cliclick
          fi
          
          # Method 1: Use keyboard shortcut (Cmd+F) to open search
          echo "Opening search field with keyboard shortcut..."
          
          # Focus search field (usually Cmd+F in System Settings)
          osascript <<'EOF' 2>/dev/null || echo "Keyboard shortcut attempt completed"
          tell application "System Events"
            tell process "System Settings"
              activate
              delay 1
              keystroke "f" using {command down}
              delay 1
            end tell
          end tell
          EOF
          
          sleep 2
          
          # Type the search term
          echo "Typing search term: $SEARCH_TERM"
          osascript <<EOF 2>/dev/null || echo "Typing attempt completed"
          tell application "System Events"
            keystroke "$SEARCH_TERM"
            delay 1
          end tell
          EOF
          
          # Wait for search results
          sleep 3
          
          # Method 2: Alternative AppleScript approach
          echo "Trying alternative AppleScript method..."
          osascript <<'EOF' 2>/dev/null || echo "Alternative method completed"
          tell application "System Settings"
            activate
            delay 2
          end tell
          
          tell application "System Events"
            tell process "System Settings"
              -- Try to find and click search field
              set searchField to text field 1 of group 1 of toolbar 1 of window 1
              set focused of searchField to true
              delay 0.5
              set value of searchField to "$SEARCH_TERM"
              delay 1
              keystroke return
            end tell
          end tell
          EOF
          
          # Additional wait for search to complete
          sleep 3
          
          # Take a screenshot to verify search worked
          verify_file="$SCREENSHOT_DIR/search_verification_$(date +%H%M%S).png"
          screencapture -x "$verify_file"
          
          if [ -f "$verify_file" ]; then
            echo "‚úÖ Search verification screenshot saved"
          else
            echo "‚ö†Ô∏è Could not save verification screenshot"
          fi
          
          echo "‚úÖ Search completed for '$SEARCH_TERM'"
          
      - name: Take Multiple Screenshots
        run: |
          echo "=== Taking $SCREENSHOT_COUNT Screenshots ==="
          echo "Delay between shots: $DELAY_SECONDS seconds"
          echo ""
          
          # Ensure System Settings is in front
          osascript <<'EOF' 2>/dev/null || true
          tell application "System Settings"
            activate
            delay 0.5
          end tell
          EOF
          
          sleep 2
          
          # Take specified number of screenshots
          for ((i=1; i<=SCREENSHOT_COUNT; i++)); do
            echo "üì∏ Screenshot $i/$SCREENSHOT_COUNT..."
            
            timestamp=$(date +%Y%m%d_%H%M%S_%3N)
            filepath="$SCREENSHOT_DIR/sharing_settings_${i}_${timestamp}.png"
            
            # Take the screenshot
            screencapture -x -t png "$filepath"
            
            if [ -f "$filepath" ]; then
              filesize=$(ls -lh "$filepath" | awk '{print $5}')
              dimensions=$(file "$filepath" 2>/dev/null | grep -o "[0-9]* x [0-9]*" || echo "Unknown")
              echo "‚úÖ Saved: $(basename "$filepath") ($filesize, $dimensions)"
              
              # Optional: Add text overlay with screenshot info
              echo "Screenshot $i - System Settings: $SEARCH_TERM" > "$SCREENSHOT_DIR/screenshot_${i}_info.txt"
              echo "Time: $(date)" >> "$SCREENSHOT_DIR/screenshot_${i}_info.txt"
              echo "Resolution: $RESOLUTION" >> "$SCREENSHOT_DIR/screenshot_${i}_info.txt"
            else
              echo "‚ö†Ô∏è Failed to take screenshot $i"
            fi
            
            # Delay between shots (except after last one)
            if [ $i -lt $SCREENSHOT_COUNT ]; then
              echo "‚è±Ô∏è Waiting $DELAY_SECONDS seconds..."
              sleep $DELAY_SECONDS
            fi
          done
          
          echo ""
          echo "‚úÖ All $SCREENSHOT_COUNT screenshots completed"
          
    
          
      - name: Create Screenshot Report
        run: |
          echo "=== Creating Screenshot Report ==="
          
          REPORT_FILE="$SCREENSHOT_DIR/screenshot_report.md"
          
          cat > "$REPORT_FILE" << EOF
          # System Settings Screenshot Report
          
          ## Test Information
          - **Date**: $(date)
          - **macOS Version**: $(sw_vers -productVersion)
          - **Search Term**: $SEARCH_TERM
          - **Screenshots Taken**: $SCREENSHOT_COUNT
          - **Delay Between Shots**: $DELAY_SECONDS seconds
          - **Screen Resolution**: $RESOLUTION
          
          ## Screenshots Taken
          EOF
          
          # List all PNG files
          echo "" >> "$REPORT_FILE"
          echo "### Screenshot Files" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          find "$SCREENSHOT_DIR" -name "*.png" -type f | sort | while read -r file; do
            filename=$(basename "$file")
            filesize=$(ls -lh "$file" | awk '{print $5}')
            echo "- **$filename** ($filesize)" >> "$REPORT_FILE"
          done
          
          ## System Information
          echo "" >> "$REPORT_FILE"
          echo "### System Information" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo '```bash' >> "$REPORT_FILE"
          sw_vers >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          
          # Display settings info
          osascript -e 'tell application "System Events" to tell process "System Settings" to get name of windows' 2>/dev/null >> "$REPORT_FILE" || true
          echo '```' >> "$REPORT_FILE"
          
          echo "‚úÖ Report created: $(basename "$REPORT_FILE")"
          
      - name: Upload Screenshots as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: system-settings-sharing-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 7
          compression-level: 9
          
      - name: Cleanup and Close Settings
        if: always()
        run: |
          echo "=== Cleaning Up ==="
          
          # Close System Settings
          echo "Closing System Settings..."
          osascript <<'EOF' 2>/dev/null || true
          tell application "System Settings"
            quit
          end tell
          EOF
          
          # Force kill if needed
          pkill -f "System Settings" 2>/dev/null || true
          pkill -f "System Preferences" 2>/dev/null || true
          
          sleep 2
          
          # Final count
          screenshot_count=$(find "$SCREENSHOT_DIR" -name "*.png" -type f 2>/dev/null | wc -l | tr -d ' ')
          echo "‚úÖ Total screenshots captured: $screenshot_count"
          echo "üìÅ Artifact directory: $SCREENSHOT_DIR"
          echo "üèÅ Workflow completed successfully!"
