name: macOS Settings Screenshots

on:
  workflow_dispatch:

jobs:
  settings-screenshots:
    runs-on: macos-15
    timeout-minutes: 10

    steps:
      - name: Setup Screenshot Directory
        run: |
          echo "=== Setting up screenshot directory ==="
          mkdir -p settings-screenshots
          echo "SCREENSHOT_DIR=$(pwd)/settings-screenshots" >> $GITHUB_ENV
          echo "‚úÖ Screenshot directory: $SCREENSHOT_DIR"

      - name: Get Screen Resolution (macOS 15.7.2)
        run: |
          echo "=== Getting Screen Resolution ==="
          
          # Multiple methods to get resolution on macOS 15
          RESOLUTION=""
          
          # Method 1: system_profiler for macOS 15
          if [ -z "$RESOLUTION" ]; then
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          
          # Method 2: Use screen command line utility
          if [ -z "$RESOLUTION" ]; then
            if command -v screenresolution &> /dev/null; then
              RESOLUTION=$(screenresolution get 2>/dev/null | grep -oE '[0-9]+x[0-9]+')
            fi
          fi
          
          # Method 3: Use AppleScript for macOS 15
          if [ -z "$RESOLUTION" ]; then
            RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | sed 's/[^0-9,]*//g' | awk -F, '{print $3 "," $4}' | sed 's/,/x/')
          fi
          
          # Fallback to GitHub Actions default
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            RESOLUTION="1920x1080"  # Typical for GitHub Actions macOS runners
            echo "‚ö†Ô∏è Using default resolution: $RESOLUTION"
          else
            echo "‚úÖ Detected resolution: $RESOLUTION"
          fi
          
          # Clean and validate
          RESOLUTION=$(echo "$RESOLUTION" | tr -d ',' | tr -d ' ' | tr -d '(' | tr -d ')')
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          if ! [[ "$WIDTH" =~ ^[0-9]+$ ]] || ! [[ "$HEIGHT" =~ ^[0-9]+$ ]]; then
            echo "‚ö†Ô∏è Invalid resolution, using defaults"
            WIDTH="1920"
            HEIGHT="1080"
            RESOLUTION="${WIDTH}x${HEIGHT}"
          fi
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          
          echo "üìè Resolution: ${WIDTH}x${HEIGHT}"

      - name: Open macOS Settings (System Preferences)
        run: |
          echo "=== Opening macOS Settings ==="
          
          # Close Settings if already open
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          echo "‚úÖ Closed any existing Settings instance"
          
          # Wait for clean state
          sleep 2
          
          # Open Settings using different methods
          echo "Opening System Settings..."
          
          # Method 1: Direct open command
          open -a "System Settings"
          
          # Method 2: AppleScript
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null || true
          
          echo "‚è≥ Waiting for Settings to load..."
          
          # Wait for Settings process
          for i in {1..20}; do
            if pgrep -f "System Settings" > /dev/null; then
              echo "‚úÖ System Settings process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Give extra time for UI to load (macOS 15 can be slow)
          echo "‚è≥ Waiting 3 seconds for UI to fully load..."
          sleep 3
          
          # Bring to front and ensure window is visible
          osascript <<'EOF' 2>/dev/null || echo "Note: Could not bring window to front"
          tell application "System Settings"
            activate
            delay 1
          end tell
          EOF
          
          echo "‚úÖ System Settings should be open and visible"

      - name: Take 3 Screenshots at 1-Second Intervals
        run: |
          echo "=== Taking 3 Screenshots at 1-Second Intervals ==="
          echo "Resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}"
          echo ""
          
          # Ensure Settings is in foreground
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null || true
          sleep 0.5
          
          for i in {1..3}; do
            echo ""
            echo "üì∏ Taking screenshot $i of 3..."
            
            timestamp=$(date +%Y%m%d_%H%M%S_%3N)
            filepath="$SCREENSHOT_DIR/settings_screenshot_${i}_${timestamp}.png"
            
            # Take screenshot using screencapture
            screencapture -x "$filepath"
            
            if [ -f "$filepath" ]; then
              filesize=$(ls -lh "$filepath" | awk '{print $5}')
              dimensions=$(file "$filepath" 2>/dev/null | grep -oE '[0-9]+ x [0-9]+' || echo "Unknown")
              echo "‚úÖ Screenshot $i saved:"
              echo "   File: $(basename $filepath)"
              echo "   Size: $filesize"
              echo "   Dimensions: $dimensions"
              
              # Quick validation of screenshot
              if [ $(stat -f%z "$filepath") -lt 1000 ]; then
                echo "   ‚ö†Ô∏è Warning: Screenshot file is very small, might be blank"
              fi
            else
              echo "‚ùå Failed to take screenshot $i"
            fi
            
            # Wait 1 second between screenshots (except after last one)
            if [ $i -lt 3 ]; then
              echo "‚è≥ Waiting 1 second..."
              sleep 1
            fi
          done
          
          # Take one more screenshot with timestamp overlay for verification
          echo ""
          echo "üì∏ Taking verification screenshot with timestamp..."
          verification_file="$SCREENSHOT_DIR/verification_$(date +%Y%m%d_%H%M%S).png"
          screencapture -x "$verification_file"
          
          echo ""
          echo "=== All Screenshots Summary ==="
          echo "Total screenshots: $(ls -1 "$SCREENSHOT_DIR"/*.png 2>/dev/null | wc -l | tr -d ' ')"
          ls -lh "$SCREENSHOT_DIR"/*.png 2>/dev/null || echo "No screenshots found"

      - name: Take Additional Screenshot of Specific Settings Panel
        run: |
          echo "=== Taking Additional Settings Panel Screenshot ==="
          
          # Try to open a specific settings panel for variety
          echo "Attempting to open Privacy & Security settings..."
          
          osascript <<'EOF' 2>/dev/null || echo "Note: Could not navigate to specific panel"
          tell application "System Settings"
            activate
            delay 1
            reveal pane id "com.apple.settings.PrivacySecurity.extension"
            delay 2
          end tell
          EOF
          
          sleep 2
          
          # Take screenshot of specific panel
          panel_file="$SCREENSHOT_DIR/privacy_panel_$(date +%Y%m%d_%H%M%S).png"
          screencapture -x "$panel_file"
          
          if [ -f "$panel_file" ]; then
            echo "‚úÖ Privacy panel screenshot saved: $(basename $panel_file)"
          fi

      - name: Create Screenshot Metadata
        run: |
          echo "=== Creating Screenshot Metadata ==="
          
          METADATA_FILE="$SCREENSHOT_DIR/metadata.txt"
          
          cat > "$METADATA_FILE" << EOF
          macOS Settings Screenshots - macOS 15.7.2
          =========================================
          Timestamp: $(date)
          macOS Version: $(sw_vers -productVersion)
          Build Version: $(sw_vers -buildVersion)
          Screen Resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}
          Screenshot Count: $(ls -1 "$SCREENSHOT_DIR"/*.png 2>/dev/null | wc -l | tr -d ' ')
          Screenshot Directory: $SCREENSHOT_DIR
          
          Screenshot Details:
          EOF
          
          # Add details for each screenshot
          for screenshot in "$SCREENSHOT_DIR"/*.png; do
            if [ -f "$screenshot" ]; then
              filename=$(basename "$screenshot")
              filesize=$(ls -lh "$screenshot" | awk '{print $5}')
              dimensions=$(file "$screenshot" 2>/dev/null | grep -oE '[0-9]+ x [0-9]+' || echo "Unknown")
              echo "- $filename: $filesize, $dimensions" >> "$METADATA_FILE"
            fi
          done
          
          echo "" >> "$METADATA_FILE"
          echo "Workflow Information:" >> "$METADATA_FILE"
          echo "Run ID: $GITHUB_RUN_ID" >> "$METADATA_FILE"
          echo "Run Number: $GITHUB_RUN_NUMBER" >> "$METADATA_FILE"
          
          echo "‚úÖ Metadata saved to: $(basename $METADATA_FILE)"
          cat "$METADATA_FILE"

      - name: Upload All Screenshots as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-settings-screenshots-15.7.2
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 7
          compression-level: 0  # No compression for faster upload

      - name: Cleanup and Close Settings
        if: always()
        run: |
          echo "=== Cleanup ==="
          
          # Take final screenshot before closing
          final_file="$SCREENSHOT_DIR/final_before_close_$(date +%H%M%S).png"
          screencapture -x "$final_file" 2>/dev/null && echo "‚úÖ Final screenshot taken" || echo "‚ö†Ô∏è Could not take final screenshot"
          
          # Close System Settings
          echo "Closing System Settings..."
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          
          # Force kill if still running
          pkill -f "System Settings" 2>/dev/null || true
          
          # List all captured files
          echo ""
          echo "=== Captured Files ==="
          find "$SCREENSHOT_DIR" -type f -name "*.png" -o -name "*.txt" | sort | while read file; do
            size=$(ls -lh "$file" | awk '{print $5}')
            echo "$(basename "$file") ($size)"
          done
          
          total_size=$(du -sh "$SCREENSHOT_DIR" | awk '{print $1}')
          echo ""
          echo "‚úÖ Cleanup complete"
          echo "üìä Total size: $total_size"
          echo "üì∑ Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l | tr -d ' ')"
