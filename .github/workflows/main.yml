name: macOS User Management and Settings Test

on:
  workflow_dispatch:

jobs:
  user-management-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Initial Screenshot
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "âœ… Initial screenshot saved: $screenshot_file"

      - name: Enable Multiple Sessions
        run: |
          echo "=== Enabling Multiple Sessions ==="
          
          # Enable multiple sessions
          echo "Enabling MultipleSessionEnabled..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled -bool true
          
          # Set multiple session name
          echo "Setting MultipleSessionName..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionName -string "FullName"
          
          # Verify the settings
          echo "Verifying settings:"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName
          
          echo "âœ… Multiple sessions enabled"

      - name: Create Admin User
        run: |
          echo "=== Creating Admin User ==="
          
          # Create new user
          echo "Creating user 'Hamiya'..."
          sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password "Hamza@157" || echo "User may already exist, continuing..."
          
          # Add user to admin group
          echo "Adding 'Hamiya' to admin group..."
          sudo dseditgroup -o edit -a Hamiya -t user admin || echo "User may already be admin, continuing..."
          
          # Verify admin membership
          echo "Verifying admin membership:"
          sudo dscl . read /Groups/admin GroupMembership || echo "Could not read admin group"
          
          echo "âœ… User creation complete"

      - name: Install cliclick for UI Automation
        run: |
          echo "=== Installing cliclick ==="
          
          # Install cliclick for precise clicking
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          else
            echo "âœ… cliclick already installed"
          fi
          
          # Verify installation
          cliclick -v || echo "cliclick version check failed"

      - name: Open System Settings
        run: |
          echo "=== Opening System Settings ==="
          
          # Close System Settings if already open
          pkill -f "System Settings" 2>/dev/null || true
          sleep 2
          
          # Open System Settings
          echo "Opening System Settings..."
          open -a "System Settings"
          
          # Wait for System Settings to open
          echo "Waiting for System Settings to launch..."
          for i in {1..10}; do
            if pgrep -f "System Settings" > /dev/null; then
              echo "âœ… System Settings process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Give UI time to load
          sleep 3
          
          # Take screenshot after opening
          screenshot_file="$SCREENSHOT_DIR/02_system_settings_open_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "âœ… System Settings opened, screenshot saved"

      - name: Click at 507,363
        run: |
          echo "=== Clicking at coordinates (507, 363) ==="
          
          # Take screenshot before click
          screenshot_file="$SCREENSHOT_DIR/03_before_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot before click saved"
          
          # Click at coordinates (507, 363)
          echo "Clicking at coordinates (507, 363)..."
          cliclick c:507,363
          
          echo "âœ… Click performed at (507, 363)"
          
          # Wait for action to complete
          sleep 2
          
          # Take screenshot after click
          screenshot_file="$SCREENSHOT_DIR/04_after_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click saved"

      - name: Search for Fast User Switching
        run: |
          echo "=== Searching for 'Fast User Switching' ==="
          
          # Wait 5 seconds as requested
          echo "Waiting 5 seconds..."
          sleep 5
          
          # Take screenshot before search
          screenshot_file="$SCREENSHOT_DIR/05_before_search_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot before search saved"
          
          # Activate System Settings window
          echo "Activating System Settings window..."
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null || true
          sleep 1
          
          # Use keyboard shortcut Cmd+F to open search
          echo "Opening search with Cmd+F..."
          osascript -e 'tell application "System Events" to keystroke "f" using command down'
          sleep 1
          
          # Type "Fast User Switching" into search
          echo "Typing 'Fast User Switching'..."
          osascript -e 'tell application "System Events" to keystroke "Fast User Switching"'
          sleep 2
          
          # Take screenshot after typing search
          screenshot_file="$SCREENSHOT_DIR/06_search_typed_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after search typed saved"
          
          # Press Enter to search
          echo "Pressing Enter to search..."
          osascript -e 'tell application "System Events" to key code 36'  # Enter key
          sleep 3
          
          # Take screenshot of search results
          screenshot_file="$SCREENSHOT_DIR/07_search_results_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot of search results saved"

      - name: Click Sequence After Search
        run: |
          echo "=== Click Sequence After Search ==="
          
          # Click at 256,242
          echo "Clicking at coordinates (256, 242)..."
          cliclick c:256,242
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/08_after_256_242_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click at (256, 242)"
          
          # Click at 827,202
          echo "Clicking at coordinates (827, 202)..."
          cliclick c:827,202
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/09_after_827_202_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click at (827, 202)"
          
          # Click at 791,221
          echo "Clicking at coordinates (791, 221)..."
          cliclick c:791,221
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/10_after_791_221_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click at (791, 221)"

      - name: Top Bar Click Sequence
        run: |
          echo "=== Top Bar Click Sequence ==="
          
          # Click at 785,7 (instead of 858,11)
          echo "Clicking at coordinates (785, 7)..."
          cliclick c:785,7
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/11_after_785_7_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click at (785, 7)"
          
          # Click at 710,73
          echo "Clicking at coordinates (710, 73)..."
          cliclick c:710,73
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/12_after_710_73_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Screenshot after click at (710, 73)"

      - name: Continuous Screenshot Capture
        run: |
          echo "=== Continuous Screenshot Capture (15 seconds) ==="
          echo "Taking 1 screenshot every second for 15 seconds..."
          
          for i in {1..15}; do
            screenshot_file="$SCREENSHOT_DIR/13_continuous_${i}_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            echo "ğŸ“¸ Screenshot $i/15: $screenshot_file"
            
            # Wait 1 second between screenshots
            if [ $i -lt 15 ]; then
              sleep 1
            fi
          done
          
          echo "âœ… Continuous screenshot capture complete"

      - name: Capture System Information
        run: |
          echo "=== Capturing System Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/system_info.txt"
          
          echo "macOS User Management Test Report" > "$INFO_FILE"
          echo "=================================" >> "$INFO_FILE"
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "System Configuration:" >> "$INFO_FILE"
          echo "-------------------" >> "$INFO_FILE"
          
          # Check multiple session settings
          echo "Multiple Session Settings:" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null >> "$INFO_FILE" || echo "Not set" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName 2>/dev/null >> "$INFO_FILE" || echo "Not set" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Check created user
          echo "User Information:" >> "$INFO_FILE"
          id Hamiya 2>/dev/null >> "$INFO_FILE" || echo "User not found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Check admin group membership
          echo "Admin Group Members:" >> "$INFO_FILE"
          dscl . read /Groups/admin GroupMembership 2>/dev/null >> "$INFO_FILE" || echo "Could not read admin group" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Get screen resolution
          echo "Screen Resolution:" >> "$INFO_FILE"
          system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 >> "$INFO_FILE" || echo "Unknown" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Actions Performed:" >> "$INFO_FILE"
          echo "----------------------" >> "$INFO_FILE"
          echo "1. Enabled MultipleSessionEnabled and set MultipleSessionName" >> "$INFO_FILE"
          echo "2. Created user 'Hamiya' with admin privileges" >> "$INFO_FILE"
          echo "3. Opened System Settings" >> "$INFO_FILE"
          echo "4. Clicked at coordinates (507, 363)" >> "$INFO_FILE"
          echo "5. Searched for 'Fast User Switching'" >> "$INFO_FILE"
          echo "6. Click sequence after search:" >> "$INFO_FILE"
          echo "   - Clicked at (256, 242)" >> "$INFO_FILE"
          echo "   - Clicked at (827, 202)" >> "$INFO_FILE"
          echo "   - Clicked at (791, 221)" >> "$INFO_FILE"
          echo "7. Top bar click sequence:" >> "$INFO_FILE"
          echo "   - Clicked at (785, 7)" >> "$INFO_FILE"
          echo "   - Clicked at (710, 73)" >> "$INFO_FILE"
          echo "8. Continuous screenshot capture: 15 screenshots (1 per second)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Screenshots Captured:" >> "$INFO_FILE"
          echo "-------------------" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -exec basename {} \; | sort >> "$INFO_FILE"
          
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)" >> "$INFO_FILE"
          
          echo "âœ… System information saved"

      - name: Cleanup
        run: |
          echo "=== Cleaning Up ==="
          
          # Close System Settings
          echo "Closing System Settings..."
          pkill -f "System Settings" 2>/dev/null || true
          
          # Take one final desktop screenshot
          screenshot_file="$SCREENSHOT_DIR/final_desktop_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "ğŸ“¸ Final desktop screenshot saved"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: macos-user-management-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-user-management-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/system_info.txt
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== macOS User Management Test Complete ==="
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  âœ… macOS Version: $(sw_vers -productVersion)"
          echo "  âœ… Multiple sessions enabled"
          echo "  âœ… User 'Hamiya' created with admin privileges"
          echo "  âœ… System Settings opened and tested"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  âœ… $SCREENSHOT_COUNT screenshots captured"
          echo ""
          echo "ğŸ¯ Test Tasks Completed:"
          echo "  1. Enabled multiple sessions"
          echo "  2. Created admin user 'Hamiya'"
          echo "  3. Opened System Settings"
          echo "  4. Clicked at (507, 363)"
          echo "  5. Searched for 'Fast User Switching'"
          echo "  6. Click sequence: (256, 242) â†’ (827, 202) â†’ (791, 221)"
          echo "  7. Top bar clicks: (785, 7) â†’ (710, 73)"
          echo "  8. Continuous screenshots: 15 screenshots (1 per second)"
          echo ""
          echo "ğŸ“ Artifacts:"
          echo "  â€¢ Screenshots uploaded as 'macos-user-management-screenshots'"
          echo "  â€¢ Test summary uploaded as 'macos-user-management-summary'"
          echo ""
          echo "âœ… All tasks completed successfully!"
