name: macOS User Creation and System Settings Test

on:
  workflow_dispatch:

jobs:
  user-creation-test:
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Initial Screenshot (Clean Desktop)
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "âœ… Initial screenshot saved: $screenshot_file"

      - name: Enable Multiple Sessions
        run: |
          echo "=== Enabling Multiple Sessions ==="
          
          # Enable multiple sessions
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled -bool true
          echo "âœ… MultipleSessionEnabled set to true"
          
          # Set multiple session name
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionName -string "FullName"
          echo "âœ… MultipleSessionName set to 'FullName'"
          
          # Verify the settings
          echo "Verifying settings..."
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName

      - name: Create Admin User
        run: |
          echo "=== Creating Admin User ==="
          
          # Check if user already exists
          if id "Hamiya" &>/dev/null; then
            echo "âš ï¸ User 'Hamiya' already exists, deleting..."
            sudo sysadminctl -deleteUser Hamiya
            sleep 2
          fi
          
          # Create new user with password
          echo "Creating user 'Hamiya'..."
          sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password "Hamza@157"
          
          if [ $? -eq 0 ]; then
            echo "âœ… User 'Hamiya' created successfully"
          else
            echo "âŒ Failed to create user"
            exit 1
          fi
          
          # Add user to admin group
          echo "Adding 'Hamiya' to admin group..."
          sudo dseditgroup -o edit -a Hamiya -t user admin
          
          if [ $? -eq 0 ]; then
            echo "âœ… User added to admin group"
          else
            echo "âŒ Failed to add user to admin group"
            exit 1
          fi
          
          # Verify admin group membership
          echo "Verifying admin group membership..."
          sudo dscl . read /Groups/admin GroupMembership

      - name: Verify User Creation
        run: |
          echo "=== Verifying User Creation ==="
          
          # Take screenshot after user creation
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/02_after_user_creation_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "âœ… User creation screenshot saved"
          
          # List all users
          echo "Current users on system:"
          dscl . list /Users | grep -v '^_'
          
          # Show user details
          echo ""
          echo "User 'Hamiya' details:"
          id Hamiya
          
          # Show admin group members
          echo ""
          echo "Admin group members:"
          dscl . read /Groups/admin GroupMembership

      - name: Open System Settings
        run: |
          echo "=== Opening System Settings ==="
          
          # Close System Settings if already open
          pkill -f "System Settings" 2>/dev/null || true
          sleep 2
          
          # Open System Settings
          echo "Opening System Settings..."
          open -a "System Settings"
          
          # Wait for System Settings to launch
          echo "Waiting for System Settings to launch..."
          for i in {1..15}; do
            if pgrep -f "System Settings" > /dev/null; then
              echo "âœ… System Settings process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Wait for UI to load
          echo "Waiting for UI to load..."
          sleep 3
          
          # Bring System Settings to front
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null || true
          sleep 2
          
          # Take screenshot after launch
          screenshot_file="$SCREENSHOT_DIR/03_system_settings_open_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "âœ… System Settings launch screenshot saved"

      - name: Click at Coordinates (507, 363)
        run: |
          echo "=== Clicking at Coordinates (507, 363) ==="
          
          # Install cliclick for precise clicking
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          fi
          
          # First screenshot before click
          echo "Taking screenshot before click..."
          screenshot_file="$SCREENSHOT_DIR/04_before_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Perform click at coordinates (507, 363)
          echo "Clicking at coordinates (507, 363)..."
          cliclick c:507,363
          
          # Wait for click to register
          echo "Waiting for click to register..."
          sleep 2
          
          # Take screenshot after click
          screenshot_file="$SCREENSHOT_DIR/05_after_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "âœ… Screenshot after click saved"
          
          # Additional wait and another screenshot
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/06_after_click_wait_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"

      - name: Test User Accounts Section
        run: |
          echo "=== Testing User Accounts Section ==="
          
          # Take screenshot of current state
          echo "Taking screenshot of current System Settings state..."
          screenshot_file="$SCREENSHOT_DIR/07_current_state_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Try to open Users & Groups using AppleScript (if click didn't work)
          echo "Attempting to access Users & Groups..."
          /usr/bin/osascript <<'EOF' 2>&1 || echo "AppleScript completed"
          tell application "System Events"
            delay 1
            tell process "System Settings"
              -- Try to click on Users & Groups in sidebar
              try
                -- Search for Users & Groups button
                click (first button of first scroll area of first window whose description contains "Users" or name contains "Users")
                delay 2
              on error
                -- Try alternative method
                keystroke "f" using {command down}
                delay 1
                keystroke "Sharing"
                delay 1
                keystroke return
                delay 2
              end try
            end tell
          end tell
          EOF
          
          # Wait for changes
          sleep 2
          
          # Take final screenshot
          screenshot_file="$SCREENSHOT_DIR/08_final_state_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "âœ… Final screenshot saved"

      - name: Cleanup
        run: |
          echo "=== Cleaning Up ==="
          
          # Close System Settings
          echo "Closing System Settings..."
          osascript -e 'tell application "System Settings" to quit' 2>/dev/null || true
          sleep 2
          
          # Force quit if needed
          pkill -f "System Settings" 2>/dev/null || true
          
          # Take final desktop screenshot
          echo "Taking final desktop screenshot..."
          screenshot_file="$SCREENSHOT_DIR/09_final_desktop_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Optional: Remove test user (commented out for inspection)
          # echo "Removing test user..."
          # sudo sysadminctl -deleteUser Hamiya 2>/dev/null || true

      - name: Capture Test Information
        run: |
          echo "=== Capturing Test Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/test_info.txt"
          
          echo "macOS User Creation Test Report" > "$INFO_FILE"
          echo "==============================" >> "$INFO_FILE"
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Configuration Changes:" >> "$INFO_FILE"
          echo "---------------------" >> "$INFO_FILE"
          echo "MultipleSessionEnabled: $(sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null || echo 'Not set')" >> "$INFO_FILE"
          echo "MultipleSessionName: $(sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName 2>/dev/null || echo 'Not set')" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "User Information:" >> "$INFO_FILE"
          echo "----------------" >> "$INFO_FILE"
          echo "Test User: Hamiya" >> "$INFO_FILE"
          echo "Full Name: Hamiyas" >> "$INFO_FILE"
          echo "Is Admin: $(dseditgroup -o checkmember -m Hamiya admin 2>/dev/null | grep -q 'yes' && echo 'Yes' || echo 'No')" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Admin Group Members:" >> "$INFO_FILE"
          dscl . read /Groups/admin GroupMembership 2>/dev/null >> "$INFO_FILE" || echo "Could not read admin group" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Click Test:" >> "$INFO_FILE"
          echo "----------" >> "$INFO_FILE"
          echo "Coordinates: (507, 363)" >> "$INFO_FILE"
          echo "Application: System Settings" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Screenshots Taken:" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -exec basename {} \; | sort >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Summary:" >> "$INFO_FILE"
          echo "-------------" >> "$INFO_FILE"
          echo "- Enabled multiple sessions" >> "$INFO_FILE"
          echo "- Created user 'Hamiya' with admin privileges" >> "$INFO_FILE"
          echo "- Opened System Settings" >> "$INFO_FILE"
          echo "- Clicked at coordinates (507, 363)" >> "$INFO_FILE"
          echo "- Captured $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l | tr -d ' ') screenshots" >> "$INFO_FILE"
          
          echo "âœ… Test info saved"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: user-creation-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: user-creation-test-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/test_info.txt
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== macOS User Creation Test Complete ==="
          echo ""
          echo "ðŸ“Š Summary:"
          echo "  âœ… macOS Version: $(sw_vers -productVersion)"
          echo "  âœ… Multiple sessions enabled"
          echo "  âœ… User 'Hamiya' created with admin privileges"
          echo "  âœ… System Settings opened"
          echo "  âœ… Click performed at coordinates (507, 363)"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  âœ… $SCREENSHOT_COUNT screenshots taken"
          echo ""
          echo "ðŸ“ Artifacts:"
          echo "  â€¢ Screenshots uploaded as 'user-creation-screenshots'"
          echo "  â€¢ Test summary uploaded as 'user-creation-test-summary'"
          echo ""
          echo "âš™ï¸ Configuration applied:"
          echo "  â€¢ MultipleSessionEnabled: $(sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null || echo 'Not set')"
          echo "  â€¢ User in admin group: $(dseditgroup -o checkmember -m Hamiya admin 2>/dev/null | grep -q 'yes' && echo 'Yes' || echo 'No')"
          echo ""
          echo "ðŸŽ¯ Test completed successfully!"
