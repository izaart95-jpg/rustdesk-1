name: macOS User Management and Settings Test

on:
  workflow_dispatch:

jobs:
  user-management-test:
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Initial Screenshot
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ Initial screenshot saved: $screenshot_file"

      - name: Enable Multiple Sessions
        run: |
          echo "=== Enabling Multiple Sessions ==="
          
          # Enable multiple sessions
          echo "Enabling MultipleSessionEnabled..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled -bool true
          
          # Set multiple session name
          echo "Setting MultipleSessionName..."
          sudo defaults write /Library/Preferences/com.apple.loginwindow MultipleSessionName -string "FullName"
          
          # Verify the settings
          echo "Verifying settings:"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName
          
          echo "‚úÖ Multiple sessions enabled"

      - name: Create Admin User
        run: |
          echo "=== Creating Admin User ==="
          
          # Create new user
          echo "Creating user 'Hamiya'..."
          sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password "Hamza@157" || echo "User may already exist, continuing..."
          
          # Add user to admin group
          echo "Adding 'Hamiya' to admin group..."
          sudo dseditgroup -o edit -a Hamiya -t user admin || echo "User may already be admin, continuing..."
          
          # Verify admin membership
          echo "Verifying admin membership:"
          sudo dscl . read /Groups/admin GroupMembership || echo "Could not read admin group"
          
          echo "‚úÖ User creation complete"

      - name: Install cliclick for UI Automation
        run: |
          echo "=== Installing cliclick ==="
          
          # Install cliclick for precise clicking
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick..."
            brew install cliclick
          else
            echo "‚úÖ cliclick already installed"
          fi
          
          # Verify installation
          cliclick -v || echo "cliclick version check failed"

      - name: Open System Settings
        run: |
          echo "=== Opening System Settings ==="
          
          # Close System Settings if already open
          pkill -f "System Settings" 2>/dev/null || true
          sleep 2
          
          # Open System Settings
          echo "Opening System Settings..."
          open -a "System Settings"
          
          # Wait for System Settings to open
          echo "Waiting for System Settings to launch..."
          for i in {1..10}; do
            if pgrep -f "System Settings" > /dev/null; then
              echo "‚úÖ System Settings process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Give UI time to load
          sleep 3
          
          # Take screenshot after opening
          screenshot_file="$SCREENSHOT_DIR/02_system_settings_open_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "‚úÖ System Settings opened, screenshot saved"

      - name: Click at 507,363
        run: |
          echo "=== Clicking at coordinates (507, 363) ==="
          
          # Take screenshot before click
          screenshot_file="$SCREENSHOT_DIR/03_before_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before click saved"
          
          # Click at coordinates (507, 363)
          echo "Clicking at coordinates (507, 363)..."
          cliclick c:507,363
          
          echo "‚úÖ Click performed at (507, 363)"
          
          # Wait for action to complete
          sleep 2
          
          # Take screenshot after click
          screenshot_file="$SCREENSHOT_DIR/04_after_click_507_363_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after click saved"

      - name: Search for Fast User Switching
        run: |
          echo "=== Searching for 'Fast User Switching' ==="
          
          # Wait 5 seconds as requested
          echo "Waiting 5 seconds..."
          sleep 5
          
          # Take screenshot before search
          screenshot_file="$SCREENSHOT_DIR/05_before_search_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot before search saved"
          
          # Activate System Settings window
          echo "Activating System Settings window..."
          osascript -e 'tell application "System Settings" to activate' 2>/dev/null || true
          sleep 1
          
          # Use keyboard shortcut Cmd+F to open search
          echo "Opening search with Cmd+F..."
          osascript -e 'tell application "System Events" to keystroke "f" using command down'
          sleep 1
          
          # Type "Fast User Switching" into search
          echo "Typing 'Fast User Switching'..."
          osascript -e 'tell application "System Events" to keystroke "Fast User Switching"'
          sleep 2
          
          # Take screenshot after typing search
          screenshot_file="$SCREENSHOT_DIR/06_search_typed_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after search typed saved"
          
          # Press Enter to search
          echo "Pressing Enter to search..."
          osascript -e 'tell application "System Events" to key code 36'  # Enter key
          sleep 3
          
          # Take screenshot of search results
          screenshot_file="$SCREENSHOT_DIR/07_search_results_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot of search results saved"

      - name: Click Sequence After Search
        run: |
          echo "=== Click Sequence After Search ==="
          
          # Click at 256,242
          echo "Clicking at coordinates (256, 242)..."
          cliclick c:256,242
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/08_after_256_242_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after click at (256, 242)"
          
          # Click at 827,202
          echo "Clicking at coordinates (827, 202)..."
          cliclick c:827,202
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/09_after_827_202_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after click at (827, 202)"
          
          # Click at 791,221
          echo "Clicking at coordinates (791, 221)..."
          cliclick c:791,221
          sleep 1
          screenshot_file="$SCREENSHOT_DIR/10_after_791_221_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after click at (791, 221)"

      - name: Fast User Switching Test
        run: |
          echo "=== Fast User Switching Test ==="
          
          # Click at 785,7 (menu bar area)
          echo "Clicking at coordinates (785, 7) - menu bar..."
          cliclick c:785,7
          sleep 2
          screenshot_file="$SCREENSHOT_DIR/11_after_menu_bar_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after menu bar click"
          
          # Now click at 710,73 (where Hamiya user button should be)
          echo "Clicking at coordinates (710, 73) - Hamiya user button..."
          cliclick c:710,73
          
          echo "‚ö†Ô∏è IMPORTANT: Login window for 'Hamiya' should appear now"
          echo "‚ö†Ô∏è Note: Login windows are secure dialogs and may not appear in screenshots"
          
          # Wait longer for login window to appear
          echo "Waiting 5 seconds for login window to appear..."
          sleep 5
          
          # Try multiple screenshot attempts for login window
          echo "Attempting to capture login window (multiple attempts)..."
          
          for i in {1..5}; do
            echo "Attempt $i/5 to capture login window..."
            screenshot_file="$SCREENSHOT_DIR/12_login_window_attempt_${i}_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            echo "üì∏ Login window capture attempt $i"
            sleep 1
          done
          
          # Also try to check if we can see loginwindow process
          echo "Checking for loginwindow processes..."
          ps aux | grep -i loginwindow | grep -v grep || echo "No loginwindow processes found"
          
          # Try to check current user sessions
          echo "Current logged in users:"
          who || echo "Could not check logged in users"

      - name: Handle Login Window (Alternative Methods)
        run: |
          echo "=== Trying Alternative Methods to Detect Login ==="
          
          # Method 1: Check for Screen Locking
          echo "Checking screen lock status..."
          python3 -c "
          import subprocess
          import sys
          
          # Try to check if screen is locked
          try:
              # This command might show if screen is locked
              result = subprocess.run(['/usr/libexec/PlistBuddy', '-c', 'Print :CGSSessionScreenIsLocked', '/dev/stdin', '2>/dev/null'], 
                                    capture_output=True, text=True, input='')
              print(f'Screen lock check: {result.stdout.strip()}')
          except:
              print('Could not check screen lock status')
          
          # Check for loginwindow process
          result = subprocess.run(['pgrep', '-x', 'loginwindow'], capture_output=True, text=True)
          if result.returncode == 0:
              print('‚úÖ loginwindow process is running')
          else:
              print('‚ùå loginwindow process is not running')
          " || echo "Python check failed"
          
          # Method 2: Check console user
          echo "Current console user info:"
          echo "Console User: $(stat -f '%Su' /dev/console)" || echo "Could not get console user"
          
          # Method 3: Check for any secure input processes
          echo "Secure input processes:"
          ps aux | grep -i "security" | grep -v grep | head -5 || echo "No relevant security processes"
          
          # Take more screenshots in case login window appeared
          echo "Taking additional screenshots..."
          for i in {1..3}; do
            screenshot_file="$SCREENSHOT_DIR/13_additional_${i}_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            sleep 1
          done

      - name: Attempt to Cancel Login
        run: |
          echo "=== Attempting to Cancel Any Login Prompt ==="
          
          # Press Escape key multiple times to cancel any dialogs
          echo "Pressing Escape to cancel any login prompts..."
          for i in {1..5}; do
            osascript -e 'tell application "System Events" to key code 53'  # Escape key
            sleep 0.5
          done
          
          # Also try Command+Period (cancel)
          osascript -e 'tell application "System Events" to keystroke "." using command down'
          sleep 1
          
          # Take screenshot after escape attempts
          screenshot_file="$SCREENSHOT_DIR/14_after_escape_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Screenshot after escape attempts"

      - name: Continuous Screenshot Capture
        run: |
          echo "=== Continuous Screenshot Capture (15 seconds) ==="
          echo "Taking 1 screenshot every second for 15 seconds..."
          
          for i in {1..15}; do
            screenshot_file="$SCREENSHOT_DIR/15_continuous_${i}_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            echo "üì∏ Screenshot $i/15: $screenshot_file"
            
            # Wait 1 second between screenshots
            if [ $i -lt 15 ]; then
              sleep 1
            fi
          done
          
          echo "‚úÖ Continuous screenshot capture complete"

      - name: Capture System Information
        run: |
          echo "=== Capturing System Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/system_info.txt"
          
          echo "macOS User Management Test Report" > "$INFO_FILE"
          echo "=================================" >> "$INFO_FILE"
          echo "Test Date: $(date)" >> "$INFO_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "System Configuration:" >> "$INFO_FILE"
          echo "-------------------" >> "$INFO_FILE"
          
          # Check multiple session settings
          echo "Multiple Session Settings:" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionEnabled 2>/dev/null >> "$INFO_FILE" || echo "Not set" >> "$INFO_FILE"
          sudo defaults read /Library/Preferences/com.apple.loginwindow MultipleSessionName 2>/dev/null >> "$INFO_FILE" || echo "Not set" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Check created user
          echo "User Information:" >> "$INFO_FILE"
          id Hamiya 2>/dev/null >> "$INFO_FILE" || echo "User not found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Check admin group membership
          echo "Admin Group Members:" >> "$INFO_FILE"
          dscl . read /Groups/admin GroupMembership 2>/dev/null >> "$INFO_FILE" || echo "Could not read admin group" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Get screen resolution
          echo "Screen Resolution:" >> "$INFO_FILE"
          system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 >> "$INFO_FILE" || echo "Unknown" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Check current session info
          echo "Current Session Info:" >> "$INFO_FILE"
          echo "Console User: $(stat -f '%Su' /dev/console 2>/dev/null || echo 'Unknown')" >> "$INFO_FILE"
          who >> "$INFO_FILE" 2>/dev/null || echo "Could not check logged in users" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Test Actions Performed:" >> "$INFO_FILE"
          echo "----------------------" >> "$INFO_FILE"
          echo "1. Enabled MultipleSessionEnabled and set MultipleSessionName" >> "$INFO_FILE"
          echo "2. Created user 'Hamiya' with admin privileges" >> "$INFO_FILE"
          echo "3. Opened System Settings" >> "$INFO_FILE"
          echo "4. Clicked at coordinates (507, 363)" >> "$INFO_FILE"
          echo "5. Searched for 'Fast User Switching'" >> "$INFO_FILE"
          echo "6. Click sequence after search:" >> "$INFO_FILE"
          echo "   - Clicked at (256, 242)" >> "$INFO_FILE"
          echo "   - Clicked at (827, 202)" >> "$INFO_FILE"
          echo "   - Clicked at (791, 221)" >> "$INFO_FILE"
          echo "7. Fast User Switching test:" >> "$INFO_FILE"
          echo "   - Clicked at (785, 7) - Menu bar" >> "$INFO_FILE"
          echo "   - Clicked at (710, 73) - Hamiya user button" >> "$INFO_FILE"
          echo "   - Note: Login window may not appear in screenshots due to security restrictions" >> "$INFO_FILE"
          echo "8. Continuous screenshot capture: 15 screenshots (1 per second)" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "IMPORTANT NOTES:" >> "$INFO_FILE"
          echo "----------------" >> "$INFO_FILE"
          echo "1. Login windows and secure dialogs often cannot be captured by screencapture" >> "$INFO_FILE"
          echo "2. The click at (710, 73) should trigger the 'Hamiya' login window" >> "$INFO_FILE"
          echo "3. If login window doesn't appear, it could be due to:" >> "$INFO_FILE"
          echo "   - Fast User Switching not properly enabled" >> "$INFO_FILE"
          echo "   - Security restrictions preventing automated login prompts" >> "$INFO_FILE"
          echo "   - The coordinates may need adjustment for your screen resolution" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          echo "Screenshots Captured:" >> "$INFO_FILE"
          echo "-------------------" >> "$INFO_FILE"
          find "$SCREENSHOT_DIR" -name "*.png" -exec basename {} \; | sort >> "$INFO_FILE"
          
          echo "" >> "$INFO_FILE"
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)" >> "$INFO_FILE"
          
          echo "‚úÖ System information saved"

      - name: Cleanup
        run: |
          echo "=== Cleaning Up ==="
          
          # Close System Settings
          echo "Closing System Settings..."
          pkill -f "System Settings" 2>/dev/null || true
          
          # Take one final desktop screenshot
          screenshot_file="$SCREENSHOT_DIR/final_desktop_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "üì∏ Final desktop screenshot saved"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: macos-user-management-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: macos-user-management-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/system_info.txt
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== macOS User Management Test Complete ==="
          echo ""
          echo "üìä Summary:"
          echo "  ‚úÖ macOS Version: $(sw_vers -productVersion)"
          echo "  ‚úÖ Multiple sessions enabled"
          echo "  ‚úÖ User 'Hamiya' created with admin privileges"
          echo "  ‚úÖ System Settings opened and tested"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  ‚úÖ $SCREENSHOT_COUNT screenshots captured"
          echo ""
          echo "‚ö†Ô∏è IMPORTANT NOTE ABOUT LOGIN WINDOW:"
          echo "  The click at (710, 73) should trigger the 'Hamiya' login window."
          echo "  However, macOS security restrictions often prevent login windows"
          echo "  from appearing in automated screenshots."
          echo "  Check the screenshots for visual feedback of the click action."
          echo ""
          echo "üìÅ Artifacts:"
          echo "  ‚Ä¢ Screenshots uploaded as 'macos-user-management-screenshots'"
          echo "  ‚Ä¢ Test summary uploaded as 'macos-user-management-summary'"
          echo ""
          echo "‚úÖ All test steps executed!"
