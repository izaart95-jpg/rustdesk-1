name: Parsec Auto Login

on:
  workflow_dispatch:

jobs:
  parsec-auto-login:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Download and install AutoHotkey v2
        shell: powershell
        run: |
          $ahkUrl = "https://download1586.mediafire.com/9a4xy9ro5wbg/tob6736a61vcdph/AutoHotkey_2.0.19_setup.exe"
          $ahkPath = "$env:TEMP\ahk-v2.exe"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath
          Start-Process -FilePath $ahkPath -ArgumentList "/silent" -Wait
          echo "AHK installed"

      - name: Create AutoHotkey script
        shell: powershell
        run: |
          $script = @'
Sleep 3000
Send "ffbewafa709@gmail.com"
Sleep 1000
Send "{Tab}"
Sleep 1000
Send "Hamza@123456"
Sleep 1000
Send "{Enter}"
Sleep 30000
Send "{Enter}"
'@

          $scriptPath = "$env:TEMP\script.ahk"
          Set-Content -Path $scriptPath -Value $script
          echo "SCRIPT_PATH=$scriptPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download and install Parsec
        shell: powershell
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:TEMP\parsec-windows.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait
          Start-Sleep -Seconds 20
          echo "Parsec installed"

      - name: Run AutoHotkey script
        shell: powershell
        run: |
          $ahkUX = "C:\Program Files\AutoHotkey\UX\AutoHotkeyUX.exe"
          $ahkV2 = "C:\Program Files\AutoHotkey\v2\AutoHotkey.exe"

          # Start Parsec first
          Start-Process "parsec:" -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5

          if (Test-Path $ahkUX) {
              Start-Process -FilePath $ahkUX -ArgumentList "`"$env:SCRIPT_PATH`""
          }
          elseif (Test-Path $ahkV2) {
              Start-Process -FilePath $ahkV2 -ArgumentList "`"$env:SCRIPT_PATH`""
          }
          else {
              Write-Host "AutoHotkey NOT FOUND!"
          }

      - name: Keep workflow alive for 6 hours
        shell: powershell
        run: |
          $end = (Get-Date).AddHours(6)
          while ((Get-Date) -lt $end) {
              $left = $end - (Get-Date)
              Write-Host "Still running... $([int]$left.TotalHours)h $([int]$left.Minutes)m left"
              Start-Sleep -Seconds 300
          }
          Write-Host "6 hours complete."

      - name: Cleanup (kill ONLY AutoHotkey)
        if: always()
        shell: powershell
        run: |
          Get-Process "AutoHotkey*" -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          Write-Host "AHK stopped â€” Parsec left running."
