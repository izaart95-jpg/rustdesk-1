name: AnyDesk macOS Testing

on:
  workflow_dispatch:

jobs:
  anydesk-test:
    runs-on: macos-latest
    timeout-minutes: 20

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          echo "RUNNER_OS=$RUNNER_OS" >> $GITHUB_ENV

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Initial Screenshot (Clean Desktop)
        run: |
          echo "=== Taking Initial Screenshot ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "âœ… Initial screenshot saved: $screenshot_file"

      - name: Download AnyDesk
        run: |
          echo "=== Downloading AnyDesk ==="
          
          # Create download directory
          mkdir -p downloads
          
          # Download AnyDesk DMG
          ANYDESK_URL="https://download.anydesk.com/anydesk.dmg"
          DMG_PATH="downloads/AnyDesk.dmg"
          
          echo "Downloading AnyDesk from: $ANYDESK_URL"
          curl -L -o "$DMG_PATH" "$ANYDESK_URL"
          
          # Verify download
          if [ -f "$DMG_PATH" ]; then
            file_size=$(ls -lh "$DMG_PATH" | awk '{print $5}')
            echo "âœ… Download successful: $file_size"
            echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV
          else
            echo "âŒ Download failed!"
            exit 1
          fi

      - name: Install AnyDesk
        run: |
          echo "=== Installing AnyDesk ==="
          
          # Mount DMG
          echo "Mounting DMG..."
          MOUNT_PATH="/Volumes/AnyDesk"
          hdiutil attach "$DMG_PATH" -nobrowse -quiet
          
          # Check DMG contents
          echo "Contents of DMG:"
          ls -la "/Volumes/AnyDesk" || true
          
          # Install to Applications
          echo "Installing to Applications..."
          if [ -f "/Volumes/AnyDesk/AnyDesk.app" ]; then
            cp -R "/Volumes/AnyDesk/AnyDesk.app" "/Applications/"
            echo "âœ… AnyDesk installed to Applications"
          else
            # Try to find any .app file
            APP_FILE=$(find "/Volumes/AnyDesk" -name "*.app" -maxdepth 1 | head -1)
            if [ -n "$APP_FILE" ]; then
              cp -R "$APP_FILE" "/Applications/"
              echo "âœ… AnyDesk installed from: $(basename "$APP_FILE")"
            else
              echo "âŒ No .app file found in DMG!"
              exit 1
            fi
          fi
          
          # Unmount DMG
          hdiutil detach "/Volumes/AnyDesk" -force 2>/dev/null || true
          
          # Verify installation
          if [ -d "/Applications/AnyDesk.app" ]; then
            echo "âœ… Installation verified: /Applications/AnyDesk.app"
            # Get version info
            if [ -f "/Applications/AnyDesk.app/Contents/Info.plist" ]; then
              VERSION=$(defaults read "/Applications/AnyDesk.app/Contents/Info" CFBundleShortVersionString 2>/dev/null || echo "Unknown")
              echo "AnyDesk Version: $VERSION"
              echo "ANYDESK_VERSION=$VERSION" >> $GITHUB_ENV
            fi
          else
            echo "âŒ Installation failed!"
            exit 1
          fi

      - name: Screenshot After Installation
        run: |
          echo "=== Screenshot After Installation ==="
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/02_after_install_$timestamp.png"
          screencapture -x "$screenshot_file"
          echo "âœ… Post-installation screenshot saved"

      - name: Launch AnyDesk
        run: |
          echo "=== Launching AnyDesk ==="
          
          # Clean up any existing instances
          pkill -f "AnyDesk" 2>/dev/null || true
          sleep 2
          
          # Launch AnyDesk
          echo "Launching AnyDesk..."
          open -a "/Applications/AnyDesk.app"
          
          # Wait for app to launch
          echo "Waiting for AnyDesk to launch..."
          for i in {1..15}; do
            if pgrep -f "AnyDesk" > /dev/null; then
              echo "âœ… AnyDesk process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Wait for UI to load
          echo "Waiting for UI to load..."
          sleep 5
          
          # Take screenshot after launch
          screenshot_file="$SCREENSHOT_DIR/03_after_launch_$(date +%Y%m%d_%H%M%S).png"
          screencapture -x "$screenshot_file"
          echo "âœ… Launch screenshot saved"

      - name: Take Application Screenshots
        run: |
          echo "=== Taking Application Screenshots ==="
          
          # Install cliclick for precise clicking
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick for UI testing..."
            brew install cliclick
          fi
          
          # Get screen dimensions
          SCREEN_INFO=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          if [ -z "$SCREEN_INFO" ] || [ "$SCREEN_INFO" = "0x0" ]; then
            SCREEN_INFO="1440x900"
            echo "âš ï¸ Using default screen resolution: $SCREEN_INFO"
          fi
          
          WIDTH=$(echo "$SCREEN_INFO" | cut -d'x' -f1)
          HEIGHT=$(echo "$SCREEN_INFO" | cut -d'x' -f2)
          
          echo "Screen: ${WIDTH}x${HEIGHT}"
          
          # Take screenshot 4 - Center of screen (where main UI might be)
          echo "Taking screenshot 4 (center)..."
          screenshot_file="$SCREENSHOT_DIR/04_center_ui_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          sleep 1
          
          # Try to interact with UI (click in common areas)
          echo "Testing UI interaction..."
          
          # Click in center (where AnyDesk ID might be displayed)
          CENTER_X=$((WIDTH / 2))
          CENTER_Y=$((HEIGHT / 2))
          cliclick c:$CENTER_X,$CENTER_Y 2>/dev/null || true
          sleep 1
          
          # Take screenshot 5 - After interaction
          echo "Taking screenshot 5 (after click)..."
          screenshot_file="$SCREENSHOT_DIR/05_after_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Click in top-right (where menu/settings might be)
          TOP_RIGHT_X=$((WIDTH - 100))
          TOP_RIGHT_Y=100
          cliclick c:$TOP_RIGHT_X,$TOP_RIGHT_Y 2>/dev/null || true
          sleep 1
          
          # Take screenshot 6 - Menu area
          echo "Taking screenshot 6 (menu area)..."
          screenshot_file="$SCREENSHOT_DIR/06_menu_area_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Take screenshot 7 - Whole screen before quit
          echo "Taking screenshot 7 (full screen)..."
          screenshot_file="$SCREENSHOT_DIR/07_full_screen_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"

      - name: Test Application Functionality
        run: |
          echo "=== Testing Application Functionality ==="
          
          # Simple test without complex AppleScript
          echo "Testing if AnyDesk is running..."
          
          if pgrep -f "AnyDesk" > /dev/null; then
            echo "âœ… AnyDesk is running"
            
            # Take a screenshot of the running app
            echo "Taking screenshot of running application..."
            screenshot_file="$SCREENSHOT_DIR/08_running_app_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
            
          else
            echo "âš ï¸ AnyDesk is not running, attempting to relaunch..."
            open -a "/Applications/AnyDesk.app"
            sleep 3
            
            # Take screenshot after relaunch
            screenshot_file="$SCREENSHOT_DIR/08_after_relaunch_$(date +%H%M%S).png"
            screencapture -x "$screenshot_file"
          fi

      - name: Cleanup and Quit
        run: |
          echo "=== Cleaning Up ==="
          
          # Take screenshot before quitting
          echo "Taking screenshot before quit..."
          screenshot_file="$SCREENSHOT_DIR/09_before_quit_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"
          
          # Quit AnyDesk
          echo "Quitting AnyDesk..."
          osascript -e 'tell application "AnyDesk" to quit' 2>/dev/null || true
          sleep 2
          
          # Force quit if needed
          pkill -f "AnyDesk" 2>/dev/null || true
          
          # Verify quit
          if ! pgrep -f "AnyDesk" > /dev/null; then
            echo "âœ… AnyDesk successfully quit"
          else
            echo "âš ï¸ AnyDesk still running after quit attempt"
          fi
          
          # Take final screenshot after quit
          echo "Taking final screenshot after quit..."
          screenshot_file="$SCREENSHOT_DIR/10_after_quit_$(date +%H%M%S).png"
          screencapture -x "$screenshot_file"

  

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: anydesk-screenshots
          path: |
            ${{ env.SCREENSHOT_DIR }}
            downloads/AnyDesk.dmg
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: anydesk-test-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/application_info.txt
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== AnyDesk Test Complete ==="
          echo ""
          echo "ğŸ“Š Summary:"
          echo "  âœ… macOS Version: $(sw_vers -productVersion)"
          echo "  âœ… AnyDesk Downloaded and Installed"
          SCREENSHOT_COUNT=$(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l | tr -d ' ')
          echo "  âœ… $SCREENSHOT_COUNT screenshots taken"
          echo "  âœ… Application launched successfully"
          echo ""
          echo "ğŸ“ Artifacts:"
          echo "  â€¢ Screenshots uploaded as 'anydesk-screenshots'"
          echo "  â€¢ Test summary uploaded as 'anydesk-test-summary'"
          echo ""
          echo "ğŸ¯ Test completed successfully!"
