name: Parsec Auto Login
on:
  workflow_dispatch:

jobs:
  parsec:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Setup directory
        run: |
          $workDir = "D:\a\SEB\SEB\parsec"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV
          Write-Host "Working in: $workDir"

      - name: Download nircmd
        run: |
          Write-Host "Downloading nircmd..."
          $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip"
          $zipPath = "$env:TEMP\nircmd.zip"
          Invoke-WebRequest -Uri $nircmdUrl -OutFile $zipPath
          Expand-Archive -Path $zipPath -DestinationPath "$env:TEMP\nircmd_extract" -Force
          $nircmdExe = Get-ChildItem -Path "$env:TEMP\nircmd_extract" -Filter "nircmd.exe" -Recurse | Select-Object -First 1
          if ($nircmdExe) {
              Copy-Item -Path $nircmdExe.FullName -Destination "$env:WORK_DIR\nircmd.exe" -Force
              Write-Host "nircmd downloaded successfully"
          }

      - name: Download and install Parsec
        run: |
          Write-Host "Downloading Parsec..."
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          Write-Host "Installing Parsec silently..."
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait -NoNewWindow
          Start-Sleep -Seconds 10

      - name: Start Parsec
        run: |
          Write-Host "Starting Parsec..."
          
          # Start Parsec
          $parsecExePath = "C:\Program Files\Parsec\parsecd.exe"
          if (Test-Path $parsecExePath) {
              Start-Process $parsecExePath
              Write-Host "Parsec started..."
          }
          
          Start-Sleep -Seconds 10

      - name: Get screen resolution and calculate coordinates
        run: |
          Write-Host "=== GETTING SCREEN RESOLUTION ==="
          
          Add-Type -AssemblyName System.Windows.Forms
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen
          $width = $screen.Bounds.Width
          $height = $screen.Bounds.Height
          
          Write-Host "Current screen resolution: ${width}x${height}"
          
          # Original coordinates at 1089x862
          $originalWidth = 1089
          $originalHeight = 862
          
          # Original field coordinates
          $originalEmailX = 455
          $originalEmailY = 411
          $originalPasswordX = 557
          $originalPasswordY = 529
          $originalLoginX = 537
          $originalLoginY = 615
          
          # Calculate scaling factors
          $scaleX = $width / $originalWidth
          $scaleY = $height / $originalHeight
          
          # Calculate new coordinates
          $emailX = [math]::Round($originalEmailX * $scaleX)
          $emailY = [math]::Round($originalEmailY * $scaleY)
          $passwordX = [math]::Round($originalPasswordX * $scaleX)
          $passwordY = [math]::Round($originalPasswordY * $scaleY)
          $loginX = [math]::Round($originalLoginX * $scaleX)
          $loginY = [math]::Round($originalLoginY * $scaleY)
          
          Write-Host "=== CALCULATED COORDINATES ==="
          Write-Host "Email field: $emailX, $emailY"
          Write-Host "Password field: $passwordX, $passwordY"
          Write-Host "Login button: $loginX, $loginY"
          
          # Save coordinates to environment variable for next steps
          echo "EMAIL_X=$emailX" >> $env:GITHUB_ENV
          echo "EMAIL_Y=$emailY" >> $env:GITHUB_ENV
          echo "PASSWORD_X=$passwordX" >> $env:GITHUB_ENV
          echo "PASSWORD_Y=$passwordY" >> $env:GITHUB_ENV
          echo "LOGIN_X=$loginX" >> $env:GITHUB_ENV
          echo "LOGIN_Y=$loginY" >> $env:GITHUB_ENV
          
          # Take screenshot of current screen
          Add-Type -AssemblyName System.Drawing
          $bitmap = New-Object System.Drawing.Bitmap($width, $height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
          $bitmap.Save("$env:WORK_DIR\screen_resolution.png", [System.Drawing.Imaging.ImageFormat]::Png)
          $graphics.Dispose()
          $bitmap.Dispose()

      - name: PRECISE LOGIN with exact coordinates
        run: |
          Write-Host "=== PRECISE LOGIN WITH EXACT COORDINATES ==="
          Write-Host "Using coordinates calculated from screen resolution"
          Write-Host "Email: $env:EMAIL_X, $env:EMAIL_Y"
          Write-Host "Password: $env:PASSWORD_X, $env:PASSWORD_Y"
          Write-Host "Login: $env:LOGIN_X, $env:LOGIN_Y"
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              # Wait a bit for Parsec to be ready
              Start-Sleep -Seconds 2
              
              # STEP 1: Click and type in EMAIL field
              Write-Host "Step 1: Clicking email field..."
              & "$env:WORK_DIR\nircmd.exe" setcursor $env:EMAIL_X $env:EMAIL_Y
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type email
              Add-Type -AssemblyName System.Windows.Forms
              Write-Host "Typing email: ffbewafa709@gmail.com"
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("ffbewafa709@gmail.com")
              Start-Sleep -Seconds 2
              
              # Screenshot after email
              Add-Type -AssemblyName System.Drawing
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\step1_email.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 2: Click and type in PASSWORD field
              Write-Host "Step 2: Clicking password field..."
              & "$env:WORK_DIR\nircmd.exe" setcursor $env:PASSWORD_X $env:PASSWORD_Y
              Start-Sleep -Milliseconds 500
              & "$env:WORKORD\nircmd.exe" sendmouse left dblclick
              Start-Sleep -Seconds 1
              
              # Type password
              Write-Host "Typing password: Hamza@123456"
              [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}")
              Start-Sleep -Milliseconds 500
              [System.Windows.Forms.SendKeys]::SendWait("Hamza@123456")
              Start-Sleep -Seconds 2
              
              # Screenshot after password
              $bitmap = New-Object System.Drawing.Bitmap($width, $height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
              $bitmap.Save("$env:WORK_DIR\step2_password.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              # STEP 3: Click LOGIN button
              Write-Host "Step 3: Clicking login button..."
              & "$env:WORK_DIR\nircmd.exe" setcursor $env:LOGIN_X $env:LOGIN_Y
              Start-Sleep -Milliseconds 500
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click
              & "$env:WORK_DIR\nircmd.exe" sendmouse left click  # Double click to be sure
              Start-Sleep -Seconds 3
              
              # Also try pressing Enter as backup
              Write-Host "Also trying Enter key..."
              [System.Windows.Forms.SendKeys]::SendWait("{ENTER}")
              Start-Sleep -Seconds 2
              
              Write-Host "Precise login completed!"
          }

      - name: Alternative method with slight offsets
        run: |
          Write-Host "=== ALTERNATIVE: TRY WITH SLIGHT OFFSETS ==="
          Start-Sleep -Seconds 5
          
          if (Test-Path "$env:WORK_DIR\nircmd.exe") {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $width = $screen.Bounds.Width
              $height = $screen.Bounds.Height
              
              # Try small offsets in case coordinates are slightly off
              $offsets = @(-5, 0, 5)
              
              foreach ($xOffset in $offsets) {
                  foreach ($yOffset in $offsets) {
                      Write-Host "--- Trying offset X:$xOffset, Y:$yOffset ---"
                      
                      # Calculate offset coordinates
                      $emailX_offset = $env:EMAIL_X + $xOffset
                      $emailY_offset = $env:EMAIL_Y + $yOffset
                      $passwordX_offset = $env:PASSWORD_X + $xOffset
                      $passwordY_offset = $env:PASSWORD_Y + $yOffset
                      $loginX_offset = $env:LOGIN_X + $xOffset
                      $loginY_offset = $env:LOGIN_Y + $yOffset
                      
                      # Click email
                      & "$env:WORK_DIR\nircmd.exe" setcursor $emailX_offset $emailY_offset
                      Start-Sleep -Milliseconds 300
                      & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                      Start-Sleep -Seconds 1
                      [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}ffbewafa709@gmail.com")
                      Start-Sleep -Seconds 1
                      
                      # Click password
                      & "$env:WORK_DIR\nircmd.exe" setcursor $passwordX_offset $passwordY_offset
                      Start-Sleep -Milliseconds 300
                      & "$env:WORK_DIR\nircmd.exe" sendmouse left dblclick
                      Start-Sleep -Seconds 1
                      [System.Windows.Forms.SendKeys]::SendWait("^a{DELETE}Hamza@123456")
                      Start-Sleep -Seconds 1
                      
                      # Click login
                      & "$env:WORK_DIR\nircmd.exe" setcursor $loginX_offset $loginY_offset
                      Start-Sleep -Milliseconds 300
                      & "$env:WORK_DIR\nircmd.exe" sendmouse left click
                      Start-Sleep -Seconds 2
                      
                      # Screenshot
                      $bitmap = New-Object System.Drawing.Bitmap($width, $height)
                      $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
                      $graphics.CopyFromScreen(0, 0, 0, 0, $bitmap.Size)
                      $bitmap.Save("$env:WORK_DIR\offset_x${xOffset}_y${yOffset}.png", [System.Drawing.Imaging.ImageFormat]::Png)
                      $graphics.Dispose()
                      $bitmap.Dispose()
                      
                      Write-Host "Offset X:$xOffset, Y:$yOffset completed"
                      Start-Sleep -Seconds 2
                  }
              }
          }

      - name: Final verification
        run: |
          Write-Host "=== FINAL VERIFICATION ==="
          Start-Sleep -Seconds 8
          
          # Take final screenshots
          for ($i = 1; $i -le 5; $i++) {
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              
              $screen = [System.Windows.Forms.Screen]::PrimaryScreen
              $bounds = $screen.Bounds
              $bitmap = New-Object System.Drawing.Bitmap($bounds.Width, $bounds.Height)
              $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
              $graphics.CopyFromScreen($bounds.Location, [System.Drawing.Point]::Empty, $bounds.Size)
              
              $fileName = "final_$i.png"
              $bitmap.Save("$env:WORK_DIR\$fileName", [System.Drawing.Imaging.ImageFormat]::Png)
              $graphics.Dispose()
              $bitmap.Dispose()
              
              Write-Host "Final screenshot $i taken"
              Start-Sleep -Seconds 1
          }
          
          # Check Parsec
          $parsecProcess = Get-Process | Where-Object { $_.ProcessName -like "*parsec*" }
          Write-Host "=== PARSEC STATUS ==="
          if ($parsecProcess) {
              Write-Host "✓ Parsec is running"
              $parsecProcess | Format-Table ProcessName, Id, MainWindowTitle -AutoSize
              
              # Check if logged in
              $loggedIn = $parsecProcess | Where-Object { 
                  $_.MainWindowTitle -ne "" -and 
                  $_.MainWindowTitle -notlike "*Sign*" -and 
                  $_.MainWindowTitle -notlike "*Login*" 
              }
              
              if ($loggedIn) {
                  Write-Host "✓ SUCCESS: Parsec appears to be logged in!"
                  Write-Host "Window title: $($loggedIn.MainWindowTitle)"
              } else {
                  Write-Host "? Parsec running but might still be on login screen"
              }
          } else {
              Write-Host "✗ Parsec is NOT running"
          }
          
          # Show all created files
          Write-Host "=== ALL FILES CREATED ==="
          Get-ChildItem -Path $env:WORK_DIR | Select-Object Name, Length | Format-Table -AutoSize

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: parsec-results
          path: D:\a\SEB\SEB\parsec\
          retention-days: 1
