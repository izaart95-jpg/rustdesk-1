name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Create Hamiya User and Setup Environment
        run: |
          echo "=== Creating Hamiya User and Setup Environment ==="
          
          # Create the Hamiya user if not exists
          if ! id Hamiya &>/dev/null; then
            echo "Creating Hamiya user..."
            sudo sysadminctl -addUser Hamiya -fullName "Hamiyas" -password Hamza@157
            sudo dseditgroup -o edit -a Hamiya -t user admin
            echo "âœ… Hamiya user created and added to admin group"
          else
            echo "âœ… Hamiya user already exists"
          fi
          
          # Create and set permissions for Hamiya's home directory
          echo "Setting up Hamiya's home directory..."
          sudo mkdir -p /Users/Hamiya
          sudo chown -R Hamiya:staff /Users/Hamiya
          sudo chmod 755 /Users/Hamiya
          
          # Create .zshrc file for Hamiya using sudo
          sudo -u Hamiya bash -c 'touch /Users/Hamiya/.zshrc'
          sudo -u Hamiya bash -c 'echo "# Hamiya user environment" > /Users/Hamiya/.zshrc'
          sudo -u Hamiya bash -c 'echo "export PATH=\"/opt/homebrew/bin:/opt/homebrew/sbin:\$PATH\"" >> /Users/Hamiya/.zshrc'
          sudo -u Hamiya bash -c 'echo "eval \"\$(/opt/homebrew/bin/brew shellenv)\"" >> /Users/Hamiya/.zshrc'
          sudo -u Hamiya bash -c 'echo "export HOME=/Users/Hamiya" >> /Users/Hamiya/.zshrc'
          
          # Fix Homebrew permissions for Hamiya user
          echo "Fixing Homebrew permissions..."
          sudo chown -R Hamiya /opt/homebrew 2>/dev/null || true
          
          echo "âœ… Hamiya environment set up"

      - name: Install Dependencies as Hamiya
        run: |
          echo "=== Installing Dependencies as Hamiya ==="
          
          # Simple one-liner to install cliclick first
          sudo -u Hamiya bash -c 'brew install cliclick'
          echo "âœ… cliclick installed"
          
          # Install RustDesk
          sudo -u Hamiya bash -c 'brew install --cask rustdesk'
          echo "âœ… RustDesk installed via Homebrew"

      - name: Get Exact Display Resolution
        run: |
          echo "=== Getting Exact Display Resolution ==="
          
          # Get resolution as current user
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | awk -F', ' '{print $3 "x" $4}')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            # Try system_profiler with better parsing
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ] || [ "$RESOLUTION" = "x" ]; then
            # Fallback to known GitHub Actions runner resolution
            RESOLUTION="1024x768"
            echo "âš ï¸ Using default GitHub Actions resolution: $RESOLUTION"
          else
            echo "Detected resolution: $RESOLUTION"
          fi
          
          # Clean up the resolution string
          RESOLUTION=$(echo "$RESOLUTION" | tr -d ',' | tr -d ' ')
          
          # Parse width and height safely
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          # Verify we got valid numbers
          if ! [[ "$WIDTH" =~ ^[0-9]+$ ]] || ! [[ "$HEIGHT" =~ ^[0-9]+$ ]]; then
            echo "âš ï¸ Invalid resolution detected, using defaults"
            WIDTH="1024"
            HEIGHT="768"
            RESOLUTION="${WIDTH}x${HEIGHT}"
          fi
          
          echo "Width: $WIDTH px"
          echo "Height: $HEIGHT px"
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV
          
          # Create screenshots directory
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Start RustDesk as Hamiya User
        run: |
          echo "=== Starting RustDesk as Hamiya User ==="
          
          # Launch RustDesk as Hamiya user
          sudo -u Hamiya open -a /Applications/RustDesk.app
          
          echo "Waiting for RustDesk to start..."
          echo "This may take 10-15 seconds..."
          
          # Wait for RustDesk process
          for i in {1..30}; do
            if pgrep -f "RustDesk" > /dev/null; then
              echo "âœ… RustDesk process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Additional wait for permission dialog
          sleep 15
          
          echo "RustDesk should be running now"
          echo "Permission prompt should appear..."

      - name: Take Initial Screenshot (Before Click)
        run: |
          echo "=== Taking Initial Screenshot (Before Permission Grant) ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          before_file="$SCREENSHOT_DIR/before_permission_$timestamp.png"
          
          # Take screenshot as current user
          screencapture -x "$before_file"
          
          if [ -f "$before_file" ]; then
            filesize=$(ls -lh "$before_file" | awk '{print $5}')
            echo "âœ… Initial screenshot saved: $before_file ($filesize)"
          else
            echo "âš ï¸ Failed to take initial screenshot"
          fi

      - name: Calculate Button Position
        run: |
          echo "=== Calculating Button Position ==="
          
          # GitHub Actions runner resolution (from your screenshots)
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIGINAL_X=462
          ORIGINAL_Y=374
          
          echo "Original resolution: ${ORIGINAL_WIDTH}x${ORIGINAL_HEIGHT}"
          echo "Current resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}"
          echo "Original button position: (${ORIGINAL_X}, ${ORIGINAL_Y})"
          
          # Calculate scaling factors using bc for precision
          X_SCALE=$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          
          echo "Scaling factors: X=${X_SCALE}, Y=${Y_SCALE}"
          
          # Calculate new coordinates (round to nearest integer)
          NEW_X=$(echo "$ORIGINAL_X * $X_SCALE" | bc | awk '{printf "%.0f", $1}')
          NEW_Y=$(echo "$ORIGINAL_Y * $Y_SCALE" | bc | awk '{printf "%.0f", $1}')
          
          # Ensure coordinates are within screen bounds
          if [ $NEW_X -lt 0 ]; then NEW_X=0; fi
          if [ $NEW_X -gt $SCREEN_WIDTH ]; then NEW_X=$((SCREEN_WIDTH - 10)); fi
          if [ $NEW_Y -lt 0 ]; then NEW_Y=0; fi
          if [ $NEW_Y -gt $SCREEN_HEIGHT ]; then NEW_Y=$((SCREEN_HEIGHT - 10)); fi
          
          echo "Calculated button position: (${NEW_X}, ${NEW_Y})"
          
          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV

      - name: Click Allow Button
        run: |
          echo "=== Clicking Allow Button ==="
          echo "Clicking at coordinates: ($BUTTON_X, $BUTTON_Y)"
          
          # Simple click using cliclick as Hamiya
          sudo -u Hamiya bash -c 'cliclick c:'"$BUTTON_X"','"$BUTTON_Y"
          echo "âœ… Click performed with cliclick"
          
          # Wait for dialog to close
          sleep 3
          
          # AppleScript alternative
          sudo -u Hamiya bash -c '/usr/bin/osascript <<EOF
          tell application "System Events"
            delay 0.5
            set xPos to '"$BUTTON_X"'
            set yPos to '"$BUTTON_Y"'
            click at {xPos, yPos}
          end tell
          EOF'
          
          # Grant permissions via tccutil
          echo "Attempting to grant screen recording permission via TCC..."
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','com.carriez.rustdesk',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,UNIXEPOCH());" 2>/dev/null || echo "Note: TCC database modification attempted"
          
          echo "âœ… All click methods attempted"

      - name: Take Verification Screenshots (2 Only)
        run: |
          echo "=== Taking Verification Screenshots (2 Only) ==="
          
          # Wait a bit for RustDesk to initialize
          sleep 5
          
          # Take only 2 verification screenshots as requested
          for i in {1..2}; do
            echo ""
            echo "ðŸ“¸ Taking verification screenshot $i/2..."
            
            timestamp=$(date +%Y%m%d_%H%M%S)
            filepath="$SCREENSHOT_DIR/verification_${i}_${timestamp}.png"
            
            screencapture -x "$filepath"
            
            if [ -f "$filepath" ]; then
              filesize=$(ls -lh "$filepath" | awk '{print $5}')
              echo "âœ… Saved: $(basename $filepath) ($filesize)"
            else
              echo "âš ï¸ Failed to take screenshot $i"
            fi
            
            if [ $i -lt 2 ]; then
              echo "   Waiting 2 seconds..."
              sleep 2
            fi
          done
          
          # List all screenshots
          echo ""
          echo "=== All Screenshots ==="
          ls -la "$SCREENSHOT_DIR/" 2>/dev/null | head -15

      - name: Additional UI Clicks
        run: |
          echo "=== Performing Additional UI Clicks ==="
          
          # Original coordinates at 1024x768: 
          # 1: (210, 563), 2: (542, 293), 3: (820, 316), 4: (828, 313), 5: (543, 478)
          
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          
          # Define all click coordinates
          declare -a CLICK_COORDS=(
            "210 563"
            "542 293" 
            "820 316"
            "828 313"
            "543 478"
          )
          
          # Calculate scaling factors
          X_SCALE=$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)
          
          echo "Original resolution: ${ORIGINAL_WIDTH}x${ORIGINAL_HEIGHT}"
          echo "Current resolution: ${SCREEN_WIDTH}x${SCREEN_HEIGHT}"
          echo "Scaling factors: X=${X_SCALE}, Y=${Y_SCALE}"
          echo ""
          
          echo "=== Performing 5 Additional Clicks ==="
          
          # Perform all 5 clicks
          for i in "${!CLICK_COORDS[@]}"; do
            ORIG_X=$(echo "${CLICK_COORDS[$i]}" | awk '{print $1}')
            ORIG_Y=$(echo "${CLICK_COORDS[$i]}" | awk '{print $2}')
            
            SCALED_X=$(echo "$ORIG_X * $X_SCALE" | bc | awk '{printf "%.0f", $1}')
            SCALED_Y=$(echo "$ORIG_Y * $Y_SCALE" | bc | awk '{printf "%.0f", $1}')
            
            echo ""
            echo "ðŸ”˜ Performing click $((i+1)) at ($SCALED_X, $SCALED_Y)..."
            
            # Click as Hamiya user
            sudo -u Hamiya bash -c 'cliclick c:'"$SCALED_X"','"$SCALED_Y"
            
            echo "âœ… Click $((i+1)) completed"
            
            if [ $i -lt $(( ${#CLICK_COORDS[@]} - 1 )) ]; then
              echo "â³ Waiting 2 seconds..."
              sleep 2
            fi
          done
          
          # Wait 2 seconds after 5th click
          echo "â³ Waiting 2 seconds after 5th click..."
          sleep 2
          
          # Take screenshot after all clicks
          echo ""
          echo "ðŸ“¸ Taking screenshot after all 5 clicks..."
          addon_file="$SCREENSHOT_DIR/addon_after_5clicks_$(date +%Y%m%d_%H%M%S).png"
          screencapture -x "$addon_file"
          
          if [ -f "$addon_file" ]; then
            filesize=$(ls -lh "$addon_file" | awk '{print $5}')
            echo "âœ… Addon screenshot saved: $(basename $addon_file) ($filesize)"
          else
            echo "âš ï¸ Failed to take addon screenshot"
          fi
          
          echo "=== All 5 Additional UI Clicks Completed ==="

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-permission-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep System Running for 20 Minutes
        run: |
          echo "=== Keeping System Running for 20 Minutes ==="
          echo "Start time: $(date)"
          echo "End time: $(date -v+20M)"
          echo ""
          echo "RustDesk should be working with screen recording permission"
          echo "Running as Hamiya user"
          echo ""
          
          # Create status file
          STATUS_FILE="$SCREENSHOT_DIR/rustdesk_status.txt"
          echo "RustDesk 20-Minute Monitoring Log" > "$STATUS_FILE"
          echo "=================================" >> "$STATUS_FILE"
          echo "User: Hamiya" >> "$STATUS_FILE"
          echo "Resolution: $RESOLUTION" >> "$STATUS_FILE"
          echo "Allow button clicked at: ($BUTTON_X, $BUTTON_Y)" >> "$STATUS_FILE"
          echo "Start time: $(date)" >> "$STATUS_FILE"
          echo "" >> "$STATUS_FILE"
          
          # Run for 20 minutes
          for minute in {1..20}; do
            current_time=$(date '+%H:%M:%S')
            echo "[$current_time] Minute $minute/20"
            echo "[$current_time] Minute $minute/20" >> "$STATUS_FILE"
            
            # Check RustDesk status
            if pgrep -f "RustDesk" > /dev/null; then
              echo "  âœ… RustDesk: Running"
              echo "  RustDesk: Running" >> "$STATUS_FILE"
              
              # Take screenshot every 4 minutes
              if [ $((minute % 4)) -eq 0 ]; then
                runtime_file="$SCREENSHOT_DIR/runtime_${minute}min_$(date +%H%M%S).png"
                if screencapture -x "$runtime_file" 2>/dev/null; then
                  echo "  ðŸ“¸ Runtime screenshot taken"
                  echo "  Screenshot at minute $minute" >> "$STATUS_FILE"
                fi
              fi
            else
              echo "  âš ï¸ RustDesk: Not running"
              echo "  RustDesk: Not running at minute $minute" >> "$STATUS_FILE"
            fi
            
            echo "  Waiting 1 minute..."
            echo "" >> "$STATUS_FILE"
            sleep 60
          done
          
          echo ""
          echo "âœ… 20-minute runtime completed at $(date)"
          echo "End time: $(date)" >> "$STATUS_FILE"

      - name: Upload Final Status
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rustdesk-final-status
          path: |
            ${{ env.SCREENSHOT_DIR }}/rustdesk_status.txt
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Final Cleanup
        if: always()
        run: |
          echo "=== Final Cleanup ==="
          
          # Final screenshot
          final_file="$SCREENSHOT_DIR/final_complete_$(date +%H%M%S).png"
          screencapture -x "$final_file" 2>/dev/null && echo "âœ… Final screenshot taken" || echo "âš ï¸ Could not take final screenshot"
          
          # Stop RustDesk
          pkill -f "RustDesk" 2>/dev/null || true
          
          echo "âœ… Cleanup complete"
          echo "Total workflow time: ~25 minutes"
          echo "Total screenshots captured: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
