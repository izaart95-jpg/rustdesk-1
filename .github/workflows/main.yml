name: RustDesk with Screen Recording Permission

on:
  workflow_dispatch:

jobs:
  rustdesk-screenshots:
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Install RustDesk via Homebrew
        run: |
          echo "=== Installing RustDesk via Homebrew ==="
          
          if ! command -v brew &> /dev/null; then
            echo "Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          
          brew install --cask rustdesk
          echo "✅ RustDesk installed via Homebrew"

      - name: Get Exact Display Resolution
        run: |
          echo "=== Getting Exact Display Resolution ==="
          
          RESOLUTION=$(osascript -e 'tell application "Finder" to get bounds of window of desktop' 2>/dev/null | awk -F', ' '{print $3 "x" $4}')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          fi
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            RESOLUTION="1024x768"
          fi
          
          RESOLUTION=$(echo "$RESOLUTION" | tr -d ',' | tr -d ' ')
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          if ! [[ "$WIDTH" =~ ^[0-9]+$ ]]; then WIDTH=1024; fi
          if ! [[ "$HEIGHT" =~ ^[0-9]+$ ]]; then HEIGHT=768; fi
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV

          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV

      - name: Start RustDesk and Wait for Permission Prompt
        run: |
          open -a /Applications/RustDesk.app
          for i in {1..30}; do
            if pgrep -f "RustDesk" > /dev/null; then break; fi
            sleep 1
          done
          sleep 15

      - name: Take Initial Screenshot (Before Click)
        run: |
          timestamp=$(date +%Y%m%d_%H%M%S)
          screencapture -x "$SCREENSHOT_DIR/before_$timestamp.png"

      - name: Calculate Button Position
        run: |
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIGINAL_X=462
          ORIGINAL_Y=374

          X_SCALE=$(echo "scale=2; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=2; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)

          NEW_X=$(echo "$ORIGINAL_X * $X_SCALE" | bc | awk '{printf "%.0f"}')
          NEW_Y=$(echo "$ORIGINAL_Y * $Y_SCALE" | bc | awk '{printf "%.0f"}')

          echo "BUTTON_X=$NEW_X" >> $GITHUB_ENV
          echo "BUTTON_Y=$NEW_Y" >> $GITHUB_ENV

      - name: Click Allow Button
        run: |
          if ! command -v cliclick &> /dev/null; then brew install cliclick; fi

          screencapture -x "$SCREENSHOT_DIR/debug_before_click.png"
          cliclick c:$BUTTON_X,$BUTTON_Y
          sleep 3
          screencapture -x "$SCREENSHOT_DIR/debug_after_click.png"

          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','com.carriez.rustdesk',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,UNIXEPOCH());" || true

      - name: Take Verification Screenshots
        run: |
          for i in {1..2}; do
            timestamp=$(date +%Y%m%d_%H%M%S)
            screencapture -x "$SCREENSHOT_DIR/verify_${i}_$timestamp.png"
            sleep 2
          done

      - name: Additional UI Clicks (Extended – Fixed)
        run: |
          ORIGINAL_WIDTH=1024
          ORIGINAL_HEIGHT=768
          ORIG_X=(210 542 820 828 543)
          ORIG_Y=(563 293 316 313 478)

          X_SCALE=$(echo "scale=4; $SCREEN_WIDTH / $ORIGINAL_WIDTH" | bc)
          Y_SCALE=$(echo "scale=4; $SCREEN_HEIGHT / $ORIGINAL_HEIGHT" | bc)

          if ! command -v cliclick &> /dev/null; then brew install cliclick; fi

          for i in {0..4}; do
            sx=$(echo "${ORIG_X[$i]} * $X_SCALE" | bc | awk '{printf "%.0f"}')
            sy=$(echo "${ORIG_Y[$i]} * $Y_SCALE" | bc | awk '{printf "%.0f"}')
            cliclick "c:$sx,$sy"
            sleep 2
          done

          screencapture -x "$SCREENSHOT_DIR/after_extended_clicks.png"

      - name: Upload All Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-permission-screenshots
          path: ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Keep System Running for 20 Minutes
        run: |
          STATUS_FILE="$SCREENSHOT_DIR/rustdesk_status.txt"
          echo "Start" > "$STATUS_FILE"

          for minute in {1..20}; do
            if pgrep -f "RustDesk" > /dev/null; then
              echo "RustDesk Running" >> "$STATUS_FILE"
            else
              echo "RustDesk NOT running" >> "$STATUS_FILE"
              if [ $((minute % 5)) -eq 0 ]; then
                  open -a /Applications/RustDesk.app || true
              fi
            fi
            sleep 60
          done

      - name: Upload Final Status
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rustdesk-final-status
          path: |
            ${{ env.SCREENSHOT_DIR }}/rustdesk_status.txt
            ${{ env.SCREENSHOT_DIR }}
          retention-days: 1

      - name: Final Cleanup
        if: always()
        run: |
          screencapture -x "$SCREENSHOT_DIR/final.png"
          pkill -f "RustDesk" || true
