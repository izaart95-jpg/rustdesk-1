name: VNC Viewer macOS Testing

on:
  workflow_dispatch:

jobs:
  vnc-viewer-test:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Check macOS Version
        run: |
          echo "=== macOS Version ==="
          sw_vers
          system_profiler SPSoftwareDataType | grep "System Version"

      - name: Download VNC Viewer
        run: |
          echo "=== Downloading VNC Viewer ==="
          
          # Create directory for downloads
          mkdir -p downloads
          
          # Download VNC Viewer DMG
          VNC_URL="https://downloads.realvnc.com/download/file/viewer.files/VNC-Viewer-7.15.1-MacOSX-universal.dmg?lai_vid=AX4E8ExGpskbQ&lai_sr=0-4&lai_sl=l"
          DMG_PATH="downloads/VNC-Viewer.dmg"
          
          echo "Downloading VNC Viewer from: ${VNC_URL}"
          curl -L -o "$DMG_PATH" "$VNC_URL"
          
          # Verify download
          if [ -f "$DMG_PATH" ]; then
            file_size=$(ls -lh "$DMG_PATH" | awk '{print $5}')
            echo "âœ… Download successful: $file_size"
            echo "DMG_PATH=$DMG_PATH" >> $GITHUB_ENV
          else
            echo "âŒ Download failed!"
            exit 1
          fi

      - name: Install VNC Viewer
        run: |
          echo "=== Installing VNC Viewer ==="
          
          # Mount DMG
          echo "Mounting DMG..."
          MOUNT_PATH="/Volumes/VNC Viewer"
          hdiutil attach "$DMG_PATH" -nobrowse
          
          # Check what's in the DMG
          echo "Contents of DMG:"
          ls -la "/Volumes/VNC Viewer" || true
          
          # Install to Applications
          echo "Installing to Applications..."
          if [ -f "/Volumes/VNC Viewer/VNC Viewer.app" ]; then
            cp -R "/Volumes/VNC Viewer/VNC Viewer.app" "/Applications/"
            echo "âœ… VNC Viewer installed to Applications"
          elif [ -f "/Volumes/VNC Viewer/VNC-Viewer.app" ]; then
            cp -R "/Volumes/VNC Viewer/VNC-Viewer.app" "/Applications/"
            echo "âœ… VNC Viewer installed to Applications"
          else
            # Try to find any .app file
            APP_FILE=$(find "/Volumes/VNC Viewer" -name "*.app" -maxdepth 1 | head -1)
            if [ -n "$APP_FILE" ]; then
              cp -R "$APP_FILE" "/Applications/"
              echo "âœ… VNC Viewer installed from: $(basename "$APP_FILE")"
            else
              echo "âŒ No .app file found in DMG!"
              exit 1
            fi
          fi
          
          # Unmount DMG
          hdiutil detach "/Volumes/VNC Viewer" -force 2>/dev/null || true
          
          # Verify installation
          if [ -d "/Applications/VNC Viewer.app" ]; then
            echo "âœ… Installation verified: /Applications/VNC Viewer.app"
          elif [ -d "/Applications/VNC-Viewer.app" ]; then
            echo "âœ… Installation verified: /Applications/VNC-Viewer.app"
            # Create alias for easier reference
            ln -s "/Applications/VNC-Viewer.app" "/Applications/VNC Viewer.app" 2>/dev/null || true
          fi

      - name: Create Screenshot Directory
        run: |
          echo "=== Creating Screenshot Directory ==="
          mkdir -p screenshots
          echo "SCREENSHOT_DIR=$(pwd)/screenshots" >> $GITHUB_ENV
          
          # Create metadata file
          METADATA_FILE="$SCREENSHOT_DIR/metadata.txt"
          echo "VNC Viewer Test Session" > "$METADATA_FILE"
          echo "======================" >> "$METADATA_FILE"
          echo "Date: $(date)" >> "$METADATA_FILE"
          echo "macOS Version: $(sw_vers -productVersion)" >> "$METADATA_FILE"
          echo "VNC Viewer Version: 7.15.1" >> "$METADATA_FILE"
          echo "" >> "$METADATA_FILE"

      - name: Get Display Information
        run: |
          echo "=== Display Information ==="
          
          # Get screen resolution
          echo "Screen Information:"
          system_profiler SPDisplaysDataType | grep -A5 "Display"
          
          # Get resolution for calculations
          RESOLUTION=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -A1 "Resolution:" | tail -1 | tr -d ' ' | sed 's/[^0-9x]//g')
          
          if [ -z "$RESOLUTION" ] || [ "$RESOLUTION" = "0x0" ]; then
            RESOLUTION="1440x900"  # Default for macOS runners
            echo "âš ï¸ Using default resolution: $RESOLUTION"
          else
            echo "Detected resolution: $RESOLUTION"
          fi
          
          WIDTH=$(echo "$RESOLUTION" | cut -d'x' -f1)
          HEIGHT=$(echo "$RESOLUTION" | cut -d'x' -f2)
          
          echo "RESOLUTION=$RESOLUTION" >> $GITHUB_ENV
          echo "SCREEN_WIDTH=$WIDTH" >> $GITHUB_ENV
          echo "SCREEN_HEIGHT=$HEIGHT" >> $GITHUB_ENV

      - name: Initial System Screenshot
        run: |
          echo "=== Taking Initial System Screenshot ==="
          
          timestamp=$(date +%Y%m%d_%H%M%S)
          screenshot_file="$SCREENSHOT_DIR/01_initial_desktop_$timestamp.png"
          
          screencapture -x "$screenshot_file"
          
          if [ -f "$screenshot_file" ]; then
            filesize=$(ls -lh "$screenshot_file" | awk '{print $5}')
            echo "âœ… Initial screenshot: $screenshot_file ($filesize)"
          else
            echo "âš ï¸ Failed to take initial screenshot"
          fi

      - name: Launch VNC Viewer
        run: |
          echo "=== Launching VNC Viewer ==="
          
          # Clean up any existing instances
          pkill -f "VNC Viewer" 2>/dev/null || true
          sleep 2
          
          # Launch VNC Viewer
          if [ -d "/Applications/VNC Viewer.app" ]; then
            echo "Launching VNC Viewer from /Applications/VNC Viewer.app"
            open -a "/Applications/VNC Viewer.app"
            APP_NAME="VNC Viewer"
          elif [ -d "/Applications/VNC-Viewer.app" ]; then
            echo "Launching VNC Viewer from /Applications/VNC-Viewer.app"
            open -a "/Applications/VNC-Viewer.app"
            APP_NAME="VNC-Viewer"
          else
            echo "âŒ VNC Viewer not found in Applications!"
            exit 1
          fi
          
          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          
          # Wait for app to launch
          echo "Waiting for VNC Viewer to launch..."
          for i in {1..30}; do
            if pgrep -f "$APP_NAME" > /dev/null; then
              echo "âœ… $APP_NAME process found (attempt $i)"
              break
            fi
            sleep 1
          done
          
          # Additional wait for UI to load
          sleep 5
          
          # Take screenshot after launch
          launch_file="$SCREENSHOT_DIR/02_after_launch_$(date +%H%M%S).png"
          screencapture -x "$launch_file"
          echo "ðŸ“¸ Launch screenshot taken"

      - name: Interact with VNC Viewer
        run: |
          echo "=== Interacting with VNC Viewer ==="
          
          # Wait a bit more for UI to stabilize
          sleep 3
          
          # Take screenshot of main window
          main_window_file="$SCREENSHOT_DIR/03_main_window_$(date +%H%M%S).png"
          screencapture -x "$main_window_file"
          echo "âœ… Main window screenshot"
          
          # Try to interact with the UI using AppleScript
          echo "Attempting to interact with VNC Viewer UI..."
          
          /usr/bin/osascript <<'EOF' || echo "AppleScript interaction attempted"
          tell application "System Events"
            delay 2
            
            -- Try to find VNC Viewer process
            if exists process "VNC Viewer" then
              tell process "VNC Viewer"
                -- Activate the application
                activate
                delay 1
                
                -- Try to get window information
                try
                  set windowNames to name of every window
                  log "VNC Viewer Windows: " & (count of windowNames)
                  
                  -- Take a screenshot after activation
                  do shell script "screencapture -x $SCREENSHOT_DIR/04_after_activate_$(date +%H%M%S).png"
                  
                  -- Try to click in common locations (center of screen)
                  set screenWidth to 1440
                  set screenHeight to 900
                  
                  -- Click in the center (where connection dialog might be)
                  click at {screenWidth / 2, screenHeight / 2}
                  delay 1
                  
                  -- Take screenshot after click
                  do shell script "screencapture -x $SCREENSHOT_DIR/05_after_center_click_$(date +%H%M%S).png"
                  
                  -- Press Escape to close any dialogs
                  key code 53
                  delay 1
                  
                on error errMsg
                  log "Error interacting with VNC Viewer: " & errMsg
                end try
              end tell
            else
              log "VNC Viewer process not found"
            end if
          end tell
          EOF
          
          # Additional screenshots of UI state
          sleep 2
          after_interaction_file="$SCREENSHOT_DIR/06_after_interaction_$(date +%H%M%S).png"
          screencapture -x "$after_interaction_file"
          echo "âœ… Post-interaction screenshot"

      - name: Test Common UI Actions
        run: |
          echo "=== Testing Common UI Actions ==="
          
          # Install cliclick for precise clicking if needed
          if ! command -v cliclick &> /dev/null; then
            echo "Installing cliclick for precise clicking..."
            brew install cliclick
          fi
          
          # Take screenshot before actions
          before_actions_file="$SCREENSHOT_DIR/07_before_actions_$(date +%H%M%S).png"
          screencapture -x "$before_actions_file"
          
          # Define click positions (relative to typical VNC Viewer UI)
          # These are educated guesses based on typical UI layouts
          CENTER_X=$((SCREEN_WIDTH / 2))
          CENTER_Y=$((SCREEN_HEIGHT / 2))
          
          TOP_CENTER_X=$CENTER_X
          TOP_CENTER_Y=$((SCREEN_HEIGHT / 4))
          
          BOTTOM_RIGHT_X=$((SCREEN_WIDTH * 3 / 4))
          BOTTOM_RIGHT_Y=$((SCREEN_HEIGHT * 3 / 4))
          
          echo "Click positions:"
          echo "  Center: ($CENTER_X, $CENTER_Y)"
          echo "  Top Center: ($TOP_CENTER_X, $TOP_CENTER_Y)"
          echo "  Bottom Right: ($BOTTOM_RIGHT_X, $BOTTOM_RIGHT_Y)"
          
          # Perform clicks with delays
          echo "Performing UI clicks..."
          
          # Click center (where connection field might be)
          cliclick c:$CENTER_X,$CENTER_Y
          sleep 1
          screenshot_center="$SCREENSHOT_DIR/08_after_center_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_center"
          
          # Click top center (where menu bar might be)
          cliclick c:$TOP_CENTER_X,$TOP_CENTER_Y
          sleep 1
          screenshot_top="$SCREENSHOT_DIR/09_after_top_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_top"
          
          # Click bottom right (where buttons might be)
          cliclick c:$BOTTOM_RIGHT_X,$BOTTOM_RIGHT_Y
          sleep 1
          screenshot_bottom="$SCREENSHOT_DIR/10_after_bottom_click_$(date +%H%M%S).png"
          screencapture -x "$screenshot_bottom"
          
          echo "âœ… UI action testing complete"

      - name: Test Menu Access
        run: |
          echo "=== Testing Menu Access ==="
          
          # Try to access menu using AppleScript
          /usr/bin/osascript <<'EOF' 2>&1 | tee -a "$SCREENSHOT_DIR/menu_test.log" || true
          tell application "System Events"
            delay 1
            
            -- Try to activate menu bar
            if exists process "VNC Viewer" then
              tell process "VNC Viewer"
                activate
                delay 1
                
                -- Try to click on menu bar items
                try
                  -- Click on Apple menu (always at top-left)
                  click at {20, 20}
                  delay 1
                  
                  -- Take screenshot of menu
                  do shell script "screencapture -x $SCREENSHOT_DIR/11_menu_display_$(date +%H%M%S).png"
                  
                  -- Press Escape to close menu
                  key code 53
                  delay 1
                  
                  -- Try File menu (common position)
                  click at {100, 20}
                  delay 1
                  do shell script "screencapture -x $SCREENSHOT_DIR/12_file_menu_$(date +%H%M%S).png"
                  key code 53
                  
                on error errMsg
                  log "Menu test error: " & errMsg
                end try
              end tell
            end if
          end tell
          EOF
          
          # Final screenshot after menu tests
          sleep 2
          final_menu_file="$SCREENSHOT_DIR/13_final_menu_test_$(date +%H%M%S).png"
          screencapture -x "$final_menu_file"

      - name: Capture Application Info
        run: |
          echo "=== Capturing Application Information ==="
          
          INFO_FILE="$SCREENSHOT_DIR/application_info.txt"
          
          echo "VNC Viewer Application Details" > "$INFO_FILE"
          echo "=============================" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Get app location
          echo "Application Locations:" >> "$INFO_FILE"
          ls -la "/Applications/" | grep -i vnc >> "$INFO_FILE" || echo "Not found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Get process info
          echo "Running Processes:" >> "$INFO_FILE"
          ps aux | grep -i "vnc" | grep -v grep >> "$INFO_FILE" || echo "No VNC processes found" >> "$INFO_FILE"
          echo "" >> "$INFO_FILE"
          
          # Get bundle info
          echo "Bundle Information:" >> "$INFO_FILE"
          if [ -d "/Applications/VNC Viewer.app" ]; then
            defaults read "/Applications/VNC Viewer.app/Contents/Info" CFBundleIdentifier 2>/dev/null >> "$INFO_FILE" || echo "Could not read bundle info" >> "$INFO_FILE"
          fi
          echo "" >> "$INFO_FILE"
          
          # Disk usage
          echo "Disk Usage:" >> "$INFO_FILE"
          if [ -d "/Applications/VNC Viewer.app" ]; then
            du -sh "/Applications/VNC Viewer.app" >> "$INFO_FILE"
          fi
          
          echo "âœ… Application info captured"

      - name: Final Screenshots and Cleanup
        run: |
          echo "=== Final Screenshots and Cleanup ==="
          
          # Take a few final screenshots
          for i in {1..3}; do
            final_file="$SCREENSHOT_DIR/14_final_${i}_$(date +%H%M%S).png"
            screencapture -x "$final_file"
            sleep 1
          done
          
          # Quit VNC Viewer
          echo "Quitting VNC Viewer..."
          osascript -e 'tell application "VNC Viewer" to quit' 2>/dev/null || true
          osascript -e 'tell application "VNC-Viewer" to quit' 2>/dev/null || true
          
          # Force quit if needed
          sleep 2
          pkill -f "VNC Viewer" 2>/dev/null || true
          pkill -f "VNC-Viewer" 2>/dev/null || true
          
          # List all screenshots
          echo ""
          echo "=== All Screenshots Captured ==="
          ls -lh "$SCREENSHOT_DIR/" | grep ".png"
          echo ""
          echo "Total screenshots: $(find "$SCREENSHOT_DIR" -name "*.png" | wc -l)"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: vnc-viewer-screenshots-macos-15.7.2
          path: |
            ${{ env.SCREENSHOT_DIR }}
            downloads/VNC-Viewer.dmg
          retention-days: 7

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vnc-viewer-test-summary
          path: |
            ${{ env.SCREENSHOT_DIR }}/metadata.txt
            ${{ env.SCREENSHOT_DIR }}/application_info.txt
            ${{ env.SCREENSHOT_DIR }}/menu_test.log
          retention-days: 7

      - name: Final Report
        run: |
          echo "=== VNC Viewer Test Complete ==="
          echo ""
          echo "ðŸ“Š Summary:"
          echo "  macOS Version: $(sw_vers -productVersion)"
          echo "  VNC Viewer: 7.15.1"
          echo "  Screenshots taken: $(find "$SCREENSHOT_DIR" -name "*.png" 2>/dev/null | wc -l)"
          echo "  Test duration: ~25 minutes"
          echo ""
          echo "âœ… Workflow completed successfully!"
