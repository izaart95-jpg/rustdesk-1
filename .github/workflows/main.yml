name: Rustdesk with Sunshine + VNC

on:
  workflow_dispatch:

env:
  DISPLAY: ":0"
  XDG_RUNTIME_DIR: "/tmp/runtime-root"
  SSHX_SESSION_FILE: /tmp/sshx_session.log

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:

      ######################################################################
      # 1️⃣ Install dependencies
      ######################################################################
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget x11vnc \
            ubuntu-desktop dbus-x11 \
            xserver-xorg-core xserver-xorg-video-dummy \
            xinit

      ######################################################################
      # 2️⃣ Start SSHX
      ######################################################################
      - name: Start SSHX
        run: |
          curl -sSf https://sshx.io/get | sh
          sshx 2>&1 | tee "$SSHX_SESSION_FILE" &
          sleep 10
          echo "SSHX URL:"
          grep -o "https://sshx.io/[a-zA-Z0-9-]*" "$SSHX_SESSION_FILE" | head -1

      ######################################################################
      # 3️⃣ Create Dummy Display for Xorg
      ######################################################################
      - name: Create dummy Xorg monitor
        run: |
          sudo mkdir -p /etc/X11/xorg.conf.d
          sudo tee /etc/X11/xorg.conf.d/10-headless-monitor.conf >/dev/null << 'EOF'
          Section "Device"
            Identifier "DummyDevice"
            Driver "dummy"
            Option "IgnoreEDID" "true"
            VideoRam 256000
          EndSection

          Section "Monitor"
            Identifier "DummyMonitor"
            HorizSync 30-70
            VertRefresh 50-75
            Modeline "1920x1080" 172.80 1920 2040 2248 2576 1080 1083 1088 1120
          EndSection

          Section "Screen"
            Identifier "DummyScreen"
            Device "DummyDevice"
            Monitor "DummyMonitor"
            SubSection "Display"
                Depth 24
                Modes "1920x1080"
            EndSubSection
          EndSection
          EOF

      ######################################################################
      # 4️⃣ Launch REAL Xorg + GNOME session
      ######################################################################
      - name: Start Xorg + GNOME
        run: |
          sudo mkdir -p $XDG_RUNTIME_DIR
          sudo chmod 700 $XDG_RUNTIME_DIR

          echo "Starting Xorg (dummy display)..."
          sudo Xorg :0 -noreset -nolisten tcp &
          sleep 6

          echo "Starting GNOME session..."
          export DISPLAY=:0
          gnome-session &
          sleep 15

      ######################################################################
      # 5️⃣ Start VNC (mirrors actual Xorg display)
      ######################################################################
      - name: Start x11vnc
        run: |
          export DISPLAY=:0
          x11vnc -display :0 -nopw -forever -repeat -shared &
          sleep 3
          echo "VNC running on port 5900"

      ######################################################################
      # 6️⃣ Install Sunshine
      ######################################################################
      - name: Install Sunshine
        run: |
          SUNSHINE_URL="https://github.com/LizardByte/Sunshine/releases/download/v2025.924.154138/sunshine-ubuntu-24.04-amd64.deb"
          wget -O sunshine.deb "$SUNSHINE_URL"
          sudo apt install -y ./sunshine.deb

      ######################################################################
      # 7️⃣ Start Sunshine on the dummy display
      ######################################################################
      - name: Start Sunshine
        run: |
          export DISPLAY=:0
          sunshine &
          sleep 5
          echo "Sunshine running on ports: 47989 (stream), 47990 (web)"

      ######################################################################
      # 8️⃣ Install and start Tailscale
      ######################################################################
      - name: Start Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --auth-key "tskey-auth-katBTfGaCP11CNTRL-hMqSUZh4fgPZNHebqNt7gPCxLc3sP2pf" --hostname "github-runner-$(date +%s)"
          sleep 10
          echo "Tailscale IP:"
          sudo tailscale ip

      ######################################################################
      # 9️⃣ Keep alive 6 hours
      ######################################################################
      - name: Keep Alive
        run: |
          for i in {1..360}; do
            echo "Minute $i / 360 - $(date)"
            sleep 60
          done

