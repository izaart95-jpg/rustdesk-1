name: Parsec AutoHotkey Automation

on:
  workflow_dispatch:

jobs:
  parsec-ahk-automation:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours

    steps:
      - name: Create working directory
        run: |
          $workDir = "$env:GITHUB_WORKSPACE\parsec-automation"
          New-Item -ItemType Directory -Path $workDir -Force
          Set-Location $workDir
          echo "WORK_DIR=$workDir" >> $env:GITHUB_ENV

      - name: Download and install AutoHotkey v2
        run: |
          $ahkUrl = "https://www.autohotkey.com/download/ahk-v2.exe"
          $ahkPath = "$env:WORK_DIR\ahk-v2.exe"
          Invoke-WebRequest -Uri $ahkUrl -OutFile $ahkPath
          
          # Install AutoHotkey silently
          Start-Process -FilePath $ahkPath -ArgumentList "/silent" -Wait
          echo "AutoHotkey installed"

      - name: Create AutoHotkey script
        run: |
          $scriptPath = "$env:WORK_DIR\script.ahk"
          @"
Sleep 3000
Send "ffbewafa709@gmail.com"
Sleep 1000
Send "{Tab}"
Sleep 1000
Send "Hamza@123456" 
Sleep 1000
Send "{Enter}"
Sleep 30000
Send "{Enter}"
"@ | Out-File -FilePath $scriptPath -Encoding utf8
          
          echo "AHK_SCRIPT_PATH=$scriptPath" >> $env:GITHUB_ENV
          Write-Host "Created AHK script at: $scriptPath"

      - name: Download and install Parsec
        run: |
          $parsecUrl = "https://builds.parsec.app/package/parsec-windows.exe"
          $parsecPath = "$env:WORK_DIR\parsec-windows.exe"
          Invoke-WebRequest -Uri $parsecUrl -OutFile $parsecPath
          
          # Install Parsec silently
          Start-Process -FilePath $parsecPath -ArgumentList "/S" -Wait
          echo "Parsec installed"
          Start-Sleep -Seconds 20

      - name: Run AutoHotkey script
        run: |
          # Find AutoHotkey executable
          $ahkExe = "C:\Program Files\AutoHotkey\UX\AutoHotkeyUX.exe"
          
          if (Test-Path $ahkExe) {
              Write-Host "Found AutoHotkey at: $ahkExe"
              Write-Host "Running script: $env:AHK_SCRIPT_PATH"
              
              # Run the AHK script
              Start-Process -FilePath $ahkExe -ArgumentList "`"$env:AHK_SCRIPT_PATH`""
          } else {
              Write-Host "AutoHotkey not found in Program Files. Searching..."
              # Try alternative locations
              $ahkExeAlt = Get-ChildItem "C:\" -Recurse -Filter "AutoHotkeyUX.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($ahkExeAlt) {
                  Start-Process -FilePath $ahkExeAlt.FullName -ArgumentList "`"$env:AHK_SCRIPT_PATH`""
              } else {
                  Write-Host "ERROR: AutoHotkey not found!"
              }
          }
          
          Write-Host "AutoHotkey script started"
          Start-Sleep -Seconds 5

      - name: Keep workflow running for 6 hours
        run: |
          Write-Host "=== Parsec AutoHotkey Automation ==="
          Write-Host "AutoHotkey script is running"
          Write-Host "Parsec should be installed and configured"
          Write-Host "Workflow will run for 6 hours or until manually cancelled"
          Write-Host "====================================="
          
          # Keep the workflow alive for 6 hours
          $startTime = Get-Date
          while ((New-TimeSpan -Start $startTime -End (Get-Date)).TotalHours -lt 6) {
              Write-Host "[$(Get-Date)] Still running... (Ctrl+C in workflow to terminate)"
              Start-Sleep -Seconds 300  # Check every 5 minutes
          }
          
          Write-Host "6-hour limit reached, workflow completed"

      - name: List files for debugging
        if: always()
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Contents of work directory:"
          Get-ChildItem -Path $env:WORK_DIR -Recurse -ErrorAction SilentlyContinue | Format-Table Name, Length, LastWriteTime
